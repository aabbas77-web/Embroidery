<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<link type="text/css" href="../../doxygen.css" rel="stylesheet">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Image Processing Library 98</title>
</head>

<body>
<h2 align="center"><a href="http://www.mip.sdu.dk/ipl98" target="_blank"><img border="0" src="ipl_doc_header.gif" width="694" height="55"></a></h2>

</body>

</html>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; </center>
<hr><h1>kernel_perspective.c</h1><div class="fragment"><pre>00001 <span class="comment">/********************************************************************</span>
00002 <span class="comment">   The Image Processing Library 98 - IPL98</span>
00003 <span class="comment">   Copyright (C) by René Dencker Eriksen - edr@mip.sdu.dk</span>
00004 <span class="comment"></span>
00005 <span class="comment">   This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">   modify it under the terms of the GNU Lesser General Public</span>
00007 <span class="comment">   License as published by the Free Software Foundation. Only</span>
00008 <span class="comment">   addition is, that if the library is used in proprietary software</span>
00009 <span class="comment">   it must be stated that IPL98 was used.</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This library is distributed in the hope that it will be useful,</span>
00012 <span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
00014 <span class="comment"></span>
00015 <span class="comment">   More details can be found in the file licence.txt distributed</span>
00016 <span class="comment">   with this library.</span>
00017 <span class="comment">*********************************************************************/</span>
00018 
00019 <span class="preprocessor">#include "kernel_perspective.h"</span>
00020 <span class="preprocessor">#include "../general_functions/ipl_general_functions_c_only.h"</span>
00021 <span class="preprocessor">#include "../kernel_error.h"</span>
00022 
00023 <span class="preprocessor">#ifdef _IPL98_USING_CPP</span>
00024 <span class="preprocessor"></span><span class="keyword">namespace </span>ipl{ <span class="comment">/* use namespace if C++ */</span>
00025 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> { <span class="comment">/* prevent name mangling for C functions */</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 <span class="comment">/************************************************/</span>
00029 <span class="comment">/********        Private functions       ********/</span>
00030 <span class="comment">/************************************************/</span>
00031 
00032 <span class="keywordtype">void</span> k_LinEq(<span class="keywordtype">int</span> n, <span class="keywordtype">double</span>**Coef, <span class="keywordtype">double</span>*Right, <span class="keywordtype">double</span>*Res);
00033 
00034 <span class="comment">/* moves given ccd-points according to k-value, calibrates camera matrix with these</span>
00035 <span class="comment">        new ccd-points. Returns the mean error for the original 3d world-points</span>
00036 <span class="comment">        transposed to 2d-coordinates and compared to the new moved ccd-points. */</span>
00037 <span class="keywordtype">double</span> k_RadialCalibAndGetMeanError(<a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> *pPointSets,<span class="keywordtype">double</span> k,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY);
00038 
00039 <span class="comment">/* finds a minimum between ax and cx with a tolerance of tol, from Numerical Recipes p. 401 */</span>
00040 <span class="keywordtype">double</span> k_CalibGoldenSearch(<span class="keywordtype">double</span> ax,<span class="keywordtype">double</span> bx,<span class="keywordtype">double</span> cx,<span class="keywordtype">double</span> tol,<span class="keywordtype">double</span> *xmin,
00041                                                   <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY);
00042 
00043 <span class="comment">/* return the mean error for all points in pWorld when transposed to </span>
00044 <span class="comment">        2D-coordinates and compared to the pPointSets 2d points, the latter must</span>
00045 <span class="comment">        be after radial distortion correction */</span>
00046 <span class="keywordtype">double</span> k_GetMeanError(<span class="keyword">const</span> <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets,<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat);
00047 
00057 <a class="code" href="structT2DFloat.html">T2DFloat</a> k_InverseRadialMove(<span class="keywordtype">double</span> xr, <span class="keywordtype">double</span> yr,<span class="keywordtype">double</span> k);
00058 
00059 <span class="comment">/* returns the inverse radial corrected point (x,y) in image and returns it in the T2DFloat return value</span>
00060 <span class="comment">        the position (xr,yr) must be relative to origin in center of image!!! */</span>
00061 <span class="preprocessor">#define CAL_SQRT2       1.4142135623731         </span><span class="comment">/*      Sqrt(2)         */</span>
00062 <span class="preprocessor">#define CAL_SQRT3       1.7320508075689         </span><span class="comment">/*  Sqrt(3)             */</span>
00063 <span class="preprocessor">#define CAL_FRAC1_3 0.33333333333333    </span><span class="comment">/*  1/3                 */</span>
00064 <span class="preprocessor">#define CAL_FRAC2_3 0.66666666666667    </span><span class="comment">/*  2/3                 */</span>
00065 <span class="preprocessor">#define CAL_N2POW1_3 1.2599210498949    </span><span class="comment">/*      pow(2,1/3)      */</span>
00066 <span class="preprocessor">#define CAL_N3POW1_3 1.4422495703074    </span><span class="comment">/*      pow(3,1/3)      */</span>
00067 <span class="preprocessor">#define CAL_N6POW2_3 3.3019272488946    </span><span class="comment">/*      pow(6,2/3)      */</span>
00068 
00069 <span class="comment">/* faster version of k_GetPixelInterpolatedFast(), assumes 8 b/p */</span>
00070 <span class="keywordtype">float</span> k_CalibGetPixelInterpolated8bp(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pInfo);
00071 
00072 <span class="comment">/************************************************/</span>
00073 <span class="comment">/********        Public functions        ********/</span>
00074 <span class="comment">/************************************************/</span>
00075 
00076 
<a name="l00077"></a><a class="code" href="group__perspective.html#a1">00077</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a1">k_CalibrateCamera</a>(<span class="keyword">const</span> <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets, <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat)
00078 { 
00079         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nc,i,j,k;
00080         <span class="keywordtype">double</span> sum;
00081         <span class="keywordtype">double</span> **anm;
00082         <span class="keywordtype">double</span> *rightm;
00083         <span class="keywordtype">double</span> **a;
00084         <span class="keywordtype">double</span> **a0;
00085         <span class="keywordtype">double</span> * Res;
00086         <span class="keywordtype">double</span> * Right;
00087 
00088         <span class="comment">/* initialize camera matrix, a44 is set to 1 the rest set to 0 */</span>
00089         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>=0;
00090         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>=0;
00091         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m8">a31</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m9">a32</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m10">a33</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m11">a34</a>=0;
00092         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m15">a44</a>=1;
00093 
00094         <span class="keywordflow">if</span> ((pPointSets==NULL) || (pMat==NULL))
00095         {
00096                 <a class="code" href="structTString.html">TString</a> str;
00097                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00098                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00099                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateCamera() One of the parameters is a NULL pointer"</span>);
00100                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00101                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00102         }
00103         nc=2*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;
00104         <span class="comment">/*      do not accept a T3D2DPoints structure with entries</span>
00105 <span class="comment">                where either the 2D or 3D point is not in use */</span>
00106         <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>!=<a class="code" href="group__corresponding3d2dpoints.html#a9">k_GetTotal3D2DPointSetsInUse</a>(pPointSets))
00107         {
00108                 <a class="code" href="structTString.html">TString</a> str;
00109                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00110                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00111                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateCamera() The T3D2DPoints structure containes entries "</span>
00112                         <span class="stringliteral">"where either the 2D or 3D point is not used"</span>);
00113                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00114                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00115         }
00116         <span class="comment">/* check if there are at least 6 point sets */</span>
00117         <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>&lt;6)
00118         {
00119                 <a class="code" href="structTString.html">TString</a> str;
00120                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00121                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00122                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateCamera() Needs at least 6 points (only %d is given)"</span>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>);
00123                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00124                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00125         }
00126         a=(<span class="keywordtype">double</span>**)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
00127         a0=(<span class="keywordtype">double</span>**)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
00128         Res=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00129         Right=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00130         anm=(<span class="keywordtype">double</span>**)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*)); <span class="comment">/* inserted by edr after warning by VC++ 6.0 */</span>
00131         rightm=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)); <span class="comment">/* inserted by edr after warning by VC++ 6.0 */</span>
00132         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00133         {
00134                 a[i]=(<span class="keywordtype">double</span>*)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00135         }
00136         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00137         {
00138                 anm[i]=(<span class="keywordtype">double</span>*)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00139         }
00140         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00141         {
00142                 <span class="keywordflow">for</span>(j=0;j&lt;11;j++)
00143                 {
00144                         anm[i][j]=0;
00145                 }
00146         }
00147         <span class="keywordflow">for</span> (i=0;i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
00148         {
00149                 anm[2*i][0]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m0">x</a>;
00150                 anm[2*i][1]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m1">y</a>;
00151                 anm[2*i][2]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m2">z</a>;
00152                 anm[2*i][3]=1;
00153                 anm[2*i+1][4]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m0">x</a>;
00154                 anm[2*i+1][5]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m1">y</a>;
00155                 anm[2*i+1][6]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m2">z</a>;
00156                 anm[2*i+1][7]=1;
00157                 anm[2*i][8]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m0">x</a>;
00158                 anm[2*i][9]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m1">y</a>;
00159                 anm[2*i][10]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m2">z</a>;
00160                 anm[2*i+1][8]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m0">x</a>;
00161                 anm[2*i+1][9]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m1">y</a>;
00162                 anm[2*i+1][10]=-pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>*pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>.<a class="code" href="structT3DFloat.html#m2">z</a>;
00163                 rightm[2*i]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>;
00164                 rightm[2*i+1]=pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>;
00165         }
00166         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00167         {
00168                 <span class="keywordflow">for</span> (j=0;j&lt;11;j++)
00169                 {
00170                         sum=0;
00171                         <span class="keywordflow">for</span> (k=0;k&lt;nc;k++)
00172                         {
00173                                 sum=sum+anm[k][i]*anm[k][j];
00174                         }
00175                         a[i][j]=sum;
00176                 }
00177         }
00178         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00179         {
00180                 sum=0;
00181                 <span class="keywordflow">for</span> (k=0;k&lt;nc;k++)
00182                         sum=sum+anm[k][i]*rightm[k];
00183                 Right[i]=sum;
00184         }
00185         k_LinEq(11,a,Right,Res);
00186         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>=(FLOAT32)Res[0];
00187         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>=(FLOAT32)Res[1];
00188         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>=(FLOAT32)Res[2];
00189         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>=(FLOAT32)Res[3];
00190         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>=(FLOAT32)Res[4];
00191         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>=(FLOAT32)Res[5];
00192         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>=(FLOAT32)Res[6];
00193         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>=(FLOAT32)Res[7];
00194         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>=(FLOAT32)Res[8];
00195         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>=(FLOAT32)Res[9];
00196         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>=(FLOAT32)Res[10];
00197         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00198         {
00199                 free(anm[i]);
00200         }
00201         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00202         {
00203                 free(a[i]);
00204         }
00205         free(Res);
00206         free(Right);
00207         free(a0);
00208         free(a);
00209         free(anm);
00210         free(rightm);
00211         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00212 }
00213 
<a name="l00214"></a><a class="code" href="group__perspective.html#a0">00214</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a0">k_Calibrate</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> np, <span class="keyword">const</span> <a class="code" href="structT3DFloat.html">T3DFloat</a> *pWorld, <span class="keyword">const</span> <a class="code" href="structT2DFloat.html">T2DFloat</a> *pCcd, <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat)
00215 { 
00216         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nc,i,j,k;
00217         <span class="keywordtype">double</span> sum;
00218         <span class="keywordtype">double</span> **anm;
00219         <span class="keywordtype">double</span> *rightm;
00220         <span class="keywordtype">double</span> **a;
00221         <span class="keywordtype">double</span> **a0;
00222         <span class="keywordtype">double</span> * Res;
00223         <span class="keywordtype">double</span> * Right;
00224 
00225         <span class="comment">/* initialize camera matrix, a44 is set to 1 the rest set to 0 */</span>
00226         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>=0;
00227         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>=0;
00228         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m8">a31</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m9">a32</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m10">a33</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m11">a34</a>=0;
00229         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>=0; pMat-&gt;<a class="code" href="structTCameraMatrix.html#m15">a44</a>=1;
00230 
00231         <span class="keywordflow">if</span> ((pWorld==NULL) || (pCcd==NULL) || (pMat==NULL))
00232         {
00233                 <a class="code" href="structTString.html">TString</a> str;
00234                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00235                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00236                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_Calibrate() One of the parameters is a NULL pointer"</span>);
00237                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00238                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00239         }
00240         nc=2*np;
00241         <span class="keywordflow">if</span> (np&lt;6)
00242         {
00243                 <a class="code" href="structTString.html">TString</a> str;
00244                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00245                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00246                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_Calibrate() Needs at least 6 points (only %d is given)"</span>,nc);
00247                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00248                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00249         }
00250         a=(<span class="keywordtype">double</span>**)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
00251         a0=(<span class="keywordtype">double</span>**)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
00252         Res=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00253         Right=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00254         anm=(<span class="keywordtype">double</span>**)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*)); <span class="comment">/* inserted by edr after warning by VC++ 6.0 */</span>
00255         rightm=(<span class="keywordtype">double</span>*)calloc(nc,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)); <span class="comment">/* inserted by edr after warning by VC++ 6.0 */</span>
00256         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00257         {
00258                 a[i]=(<span class="keywordtype">double</span>*)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00259         }
00260         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00261         {
00262                 anm[i]=(<span class="keywordtype">double</span>*)calloc(11,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00263         }
00264         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00265         {
00266                 <span class="keywordflow">for</span>(j=0;j&lt;11;j++)
00267                 {
00268                         anm[i][j]=0;
00269                 }
00270         }
00271         <span class="keywordflow">for</span> (i=0;i&lt;np;i++)
00272         {
00273                 anm[2*i][0]=pWorld[i].<a class="code" href="structT3DFloat.html#m0">x</a>;
00274                 anm[2*i][1]=pWorld[i].<a class="code" href="structT3DFloat.html#m1">y</a>;
00275                 anm[2*i][2]=pWorld[i].<a class="code" href="structT3DFloat.html#m2">z</a>;
00276                 anm[2*i][3]=1;
00277                 anm[2*i+1][4]=pWorld[i].<a class="code" href="structT3DFloat.html#m0">x</a>;
00278                 anm[2*i+1][5]=pWorld[i].<a class="code" href="structT3DFloat.html#m1">y</a>;
00279                 anm[2*i+1][6]=pWorld[i].<a class="code" href="structT3DFloat.html#m2">z</a>;
00280                 anm[2*i+1][7]=1;
00281                 anm[2*i][8]=-pCcd[i].<a class="code" href="structT2DFloat.html#m0">x</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m0">x</a>;
00282                 anm[2*i][9]=-pCcd[i].<a class="code" href="structT2DFloat.html#m0">x</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m1">y</a>;
00283                 anm[2*i][10]=-pCcd[i].<a class="code" href="structT2DFloat.html#m0">x</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m2">z</a>;
00284                 anm[2*i+1][8]=-pCcd[i].<a class="code" href="structT2DFloat.html#m1">y</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m0">x</a>;
00285                 anm[2*i+1][9]=-pCcd[i].<a class="code" href="structT2DFloat.html#m1">y</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m1">y</a>;
00286                 anm[2*i+1][10]=-pCcd[i].<a class="code" href="structT2DFloat.html#m1">y</a>*pWorld[i].<a class="code" href="structT3DFloat.html#m2">z</a>;
00287                 rightm[2*i]=pCcd[i].<a class="code" href="structT2DFloat.html#m0">x</a>;
00288                 rightm[2*i+1]=pCcd[i].<a class="code" href="structT2DFloat.html#m1">y</a>;
00289         }
00290         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00291         {
00292                 <span class="keywordflow">for</span> (j=0;j&lt;11;j++)
00293                 {
00294                         sum=0;
00295                         <span class="keywordflow">for</span> (k=0;k&lt;nc;k++)
00296                         {
00297                                 sum=sum+anm[k][i]*anm[k][j];
00298                         }
00299                         a[i][j]=sum;
00300                 }
00301         }
00302         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00303         {
00304                 sum=0;
00305                 <span class="keywordflow">for</span> (k=0;k&lt;nc;k++)
00306                         sum=sum+anm[k][i]*rightm[k];
00307                 Right[i]=sum;
00308         }
00309         k_LinEq(11,a,Right,Res);
00310         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>=(FLOAT32)Res[0];
00311         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>=(FLOAT32)Res[1];
00312         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>=(FLOAT32)Res[2];
00313         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>=(FLOAT32)Res[3];
00314         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>=(FLOAT32)Res[4];
00315         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>=(FLOAT32)Res[5];
00316         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>=(FLOAT32)Res[6];
00317         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>=(FLOAT32)Res[7];
00318         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>=(FLOAT32)Res[8];
00319         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>=(FLOAT32)Res[9];
00320         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>=(FLOAT32)Res[10];
00321         <span class="keywordflow">for</span> (i=0;i&lt;nc;i++)
00322         {
00323                 free(anm[i]);
00324         }
00325         <span class="keywordflow">for</span> (i=0;i&lt;11;i++)
00326         {
00327                 free(a[i]);
00328         }
00329         free(Res);
00330         free(Right);
00331         free(a0);
00332         free(a);
00333         free(anm);
00334         free(rightm);
00335         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00336 }
00337 
<a name="l00338"></a><a class="code" href="group__perspective.html#a2">00338</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a2">k_Calc3DTo2D</a>(<a class="code" href="structT3DFloat.html">T3DFloat</a> w,<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <a class="code" href="structT2DFloat.html">T2DFloat</a>* pPnt)
00339 {
00340         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> den;
00341         den=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>*w.<a class="code" href="structT3DFloat.html#m0">x</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>*w.<a class="code" href="structT3DFloat.html#m1">y</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>*w.<a class="code" href="structT3DFloat.html#m2">z</a>+1;
00342         pPnt-&gt;<a class="code" href="structT2DFloat.html#m0">x</a>=(FLOAT32)(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>*w.<a class="code" href="structT3DFloat.html#m0">x</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>*w.<a class="code" href="structT3DFloat.html#m1">y</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>*w.<a class="code" href="structT3DFloat.html#m2">z</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>)/den;
00343         pPnt-&gt;<a class="code" href="structT2DFloat.html#m1">y</a>=(FLOAT32)(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>*w.<a class="code" href="structT3DFloat.html#m0">x</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>*w.<a class="code" href="structT3DFloat.html#m1">y</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>*w.<a class="code" href="structT3DFloat.html#m2">z</a>+pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>)/den;
00344 }
00345 
<a name="l00346"></a><a class="code" href="group__perspective.html#a3">00346</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a3">k_Direction</a>(<a class="code" href="structT2DFloat.html">T2DFloat</a> p,<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat,<a class="code" href="structT3DFloat.html">T3DFloat</a>* pDir)
00347 {
00348         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> norm;
00349         pDir-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>=-(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)+
00350                 (pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>);
00351         pDir-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>=+(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)-
00352                 (pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>);
00353         pDir-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>=(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)-
00354                 (pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>*p.<a class="code" href="structT2DFloat.html#m1">y</a>)*(pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>*p.<a class="code" href="structT2DFloat.html#m0">x</a>);
00355         norm=(FLOAT32)sqrt(pDir-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>*pDir-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>+pDir-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>*pDir-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>+pDir-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>*pDir-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>);
00356         pDir-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>=pDir-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>/norm;
00357         pDir-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>=pDir-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>/norm;
00358         pDir-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>=pDir-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>/norm;
00359 }
00360 
<a name="l00361"></a><a class="code" href="group__perspective.html#a4">00361</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a4">k_PinHole</a>(<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <a class="code" href="structT3DFloat.html">T3DFloat</a>* pPinHole)
00362 {
00363         <span class="keywordtype">int</span> i;
00364         <span class="keywordtype">double</span>** a=(<span class="keywordtype">double</span>**)calloc(3,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
00365         <span class="keywordtype">double</span> * Res=(<span class="keywordtype">double</span>*)calloc(3,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00366         <span class="keywordtype">double</span> * Right=(<span class="keywordtype">double</span>*)calloc(3,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00367         
00368         <span class="keywordflow">for</span> (i=0;i&lt;3;i++)
00369                 a[i]=(<span class="keywordtype">double</span>*)calloc(3,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00370 
00371         a[0][0]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>;
00372         a[0][1]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>;
00373         a[0][2]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>;
00374         a[1][0]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>;
00375         a[1][1]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>;
00376         a[1][2]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>;
00377         a[2][0]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>;
00378         a[2][1]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>;
00379         a[2][2]=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>;
00380         Right[0]=-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>;
00381         Right[1]=-pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>;
00382         Right[2]=-1;
00383         k_LinEq(3,a,Right,Res);
00384         pPinHole-&gt;<a class="code" href="structT3DFloat.html#m0">x</a>=(FLOAT32)Res[0];
00385         pPinHole-&gt;<a class="code" href="structT3DFloat.html#m1">y</a>=(FLOAT32)Res[1];
00386         pPinHole-&gt;<a class="code" href="structT3DFloat.html#m2">z</a>=(FLOAT32)Res[2];
00387         free(Res);
00388         free(Right);
00389         <span class="keywordflow">for</span> (i=0;i&lt;3;i++)
00390                 free(a[i]);
00391         free(a);
00392 }
00393 
<a name="l00394"></a><a class="code" href="group__perspective.html#a5">00394</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a5">k_CalibrateWithRadialDist</a>(<a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets,<a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, 
00395                                                            <span class="keywordtype">double</span>* k, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
00396 {
00397         <span class="keywordflow">if</span> ((pPointSets==NULL) || (pMat==NULL) || (k==NULL))
00398         {
00399                 <a class="code" href="structTString.html">TString</a> str;
00400                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00401                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00402                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,
00403                         <span class="stringliteral">"k_CalibrateWithRadialDist() One of the given parameters is a NULL pointer"</span>);
00404                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00405                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00406         }
00407         <span class="comment">/*      do not accept a T3D2DPoints structure with entries</span>
00408 <span class="comment">                where either the 2D or 3D point is not in use */</span>
00409         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>!=<a class="code" href="group__corresponding3d2dpoints.html#a9">k_GetTotal3D2DPointSetsInUse</a>(pPointSets))
00410         {
00411                 <a class="code" href="structTString.html">TString</a> str;
00412                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00413                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00414                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() The T3D2DPoints structure containes entries "</span>
00415                         <span class="stringliteral">"where either the 2D or 3D point is not used"</span>);
00416                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00417                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00418         }
00419         <span class="comment">/* check if there are at least 6 point sets */</span>
00420         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>&lt;6)
00421         {
00422                 <a class="code" href="structTString.html">TString</a> str;
00423                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00424                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00425                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() Need 6 refernce marks "</span>
00426                         <span class="stringliteral">"(current is %d)"</span>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>);
00427                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00428                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00429         }
00430         <span class="keywordflow">else</span>
00431         {
00432                 <span class="keyword">const</span> <span class="keywordtype">double</span> LOWER_VAL=0;
00433                 <span class="keyword">const</span> <span class="keywordtype">double</span> UPPER_VAL=0.000005; <span class="comment">/* 5e-6 since version 1.60*/</span>
00434           <span class="comment">/*const double UPPER_VAL=0.000001;*/</span> <span class="comment">/* 1e-6 */</span>
00435                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ITERATIONS=100;
00436                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00437                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iterate=0;
00438                 <span class="keywordtype">double</span> LowValError,UpperValError,NewError;
00439                 <span class="keywordtype">double</span> LowVal=LOWER_VAL;
00440                 <span class="keywordtype">double</span> UpperVal=UPPER_VAL;
00441                 <span class="keywordtype">double</span> NewVal;
00442                 <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> NewPointSets;
00443                 <a class="code" href="group__corresponding3d2dpoints.html#a0">k_Init3D2DPoints</a>(&amp;NewPointSets);
00444                 <span class="comment">/* initialize system */</span>
00445                 LowValError=k_RadialCalibAndGetMeanError(pPointSets,LowVal,CenterX,CenterY);
00446                 UpperValError=k_RadialCalibAndGetMeanError(pPointSets,UpperVal,CenterX,CenterY);
00447 
00448                 <span class="comment">/* search for a "bracketing minimum" error between 0 and UPPER_VAL,</span>
00449 <span class="comment">                        when found a golden search method is used for finding the minimum</span>
00450 <span class="comment">                        error between this bracketed interval */</span>
00451                 <span class="keywordflow">for</span>(iterate=0;iterate&lt;ITERATIONS;iterate++)
00452                 {
00453                         NewVal=(LowVal+UpperVal)/2.0;
00454                         NewError=k_RadialCalibAndGetMeanError(pPointSets,NewVal,CenterX,CenterY);
00455                 
00456                         <span class="keywordflow">if</span> ((NewError&gt;LowValError) &amp;&amp; (NewError&lt;UpperValError))
00457                         {
00458                                 UpperVal=NewVal;
00459                                 UpperValError=NewError;
00460                         }
00461                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NewError&lt;LowValError) &amp;&amp; (NewError&gt;UpperValError))
00462                         {
00463                                 LowVal=NewVal;
00464                                 LowValError=NewError;
00465                         }
00466                         <span class="keywordflow">else</span>
00467                         {       
00468                                 <span class="comment">/* if we end up here, we have a bracketed minimum, </span>
00469 <span class="comment">                                        that is: NewError&lt;LowValError and NewError&lt;UpperValError */</span>
00470                                 <span class="keywordtype">double</span> Tolerance=1e-6;
00471                                 <span class="comment">/*double test=*/</span>
00472                 k_CalibGoldenSearch(LowVal,NewVal,UpperVal,Tolerance,&amp;NewVal,
00473                                                   pPointSets,CenterX,CenterY);
00474                                 <span class="keywordflow">break</span>;
00475 
00476                         }
00477                 }
00478                 <span class="keywordflow">if</span> (iterate&gt;=ITERATIONS)
00479                 {
00480                         <span class="comment">/* a bracketed minimum was never found, warn the user */</span>
00481                         <a class="code" href="structTString.html">TString</a> str;
00482                         <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00483                         <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00484                         <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() Couldn't find a suitable"</span>
00485                                 <span class="stringliteral">" distortion value k better than the initial 0 (no radial correction)"</span>);
00486                         <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00487                 }
00488 
00489                 *k=NewVal;
00490                 <a class="code" href="group__corresponding3d2dpoints.html#a8">k_Copy3D2DPoints</a>(&amp;NewPointSets,pPointSets);
00491                 <span class="keywordflow">for</span>(i=0; i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
00492                 {
00493                         <a class="code" href="structT2DFloat.html">T2DFloat</a> P2d;
00494                         P2d=<a class="code" href="group__perspective.html#a9">k_GetPosRadRemoved</a>(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>,*k,CenterX,CenterY);
00495                         <a class="code" href="group__corresponding3d2dpoints.html#a18">k_SetPoint2DIn3D2DPoints</a>(&amp;P2d,i,&amp;NewPointSets);
00496                 }
00497                 <a class="code" href="group__perspective.html#a1">k_CalibrateCamera</a>(&amp;NewPointSets,pMat);
00498                 <a class="code" href="group__corresponding3d2dpoints.html#a1">k_Empty3D2DPoints</a>(&amp;NewPointSets);
00499                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00500         }
00501 }
00502 
<a name="l00503"></a><a class="code" href="group__perspective.html#a6">00503</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a6">k_Calc3DTo2DRad</a>(<a class="code" href="structT3DFloat.html">T3DFloat</a> w, <span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <span class="keywordtype">double</span> k, <a class="code" href="structT2DFloat.html">T2DFloat</a>* pPnt, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
00504 {
00505         <a class="code" href="group__perspective.html#a2">k_Calc3DTo2D</a>(w,pMat,pPnt);
00506         <span class="comment">/* inverse adjust for radial distortion */</span>
00507         (*pPnt)=k_InverseRadialMove(pPnt-&gt;<a class="code" href="structT2DFloat.html#m0">x</a>-CenterX,pPnt-&gt;<a class="code" href="structT2DFloat.html#m1">y</a>-CenterY,k);
00508         pPnt-&gt;<a class="code" href="structT2DFloat.html#m0">x</a>+=(float)CenterX;
00509         pPnt-&gt;<a class="code" href="structT2DFloat.html#m1">y</a>+=(float)CenterY;
00510 }
00511 
<a name="l00512"></a><a class="code" href="group__perspective.html#a7">00512</a> <a class="code" href="structT2DInt.html">T2DInt</a> <a class="code" href="group__perspective.html#a7">k_GetMaxRadialDisplacement</a>(<span class="keywordtype">double</span> k, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
00513 {
00514         <a class="code" href="structT2DInt.html">T2DInt</a> MaxRadDispl;
00515         MaxRadDispl.<a class="code" href="structT2DInt.html#m0">x</a>=<a class="code" href="group__c__globals.html#a5">k_Round</a>(k*CenterX*(CenterX*CenterX+CenterY*CenterY));
00516         MaxRadDispl.<a class="code" href="structT2DInt.html#m1">y</a>=<a class="code" href="group__c__globals.html#a5">k_Round</a>(k*CenterY*(CenterX*CenterX+CenterY*CenterY));
00517         <span class="keywordflow">return</span> MaxRadDispl;
00518 }
00519 
<a name="l00520"></a><a class="code" href="group__perspective.html#a8">00520</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a8">k_RemoveRadialDistortion</a>(<a class="code" href="structTImage.html">TImage</a>* pDest, <a class="code" href="structTImage.html">TImage</a>* pSource, <span class="keywordtype">double</span> k, <span class="keywordtype">bool</span> PreserveImageSize)
00521 {
00522         <a class="code" href="structTString.html">TString</a> str;
00523         <a class="code" href="structTImage.html">TImage</a>* pTarget=pDest;
00524         <span class="keywordtype">bool</span> CopyToSource=<span class="keyword">false</span>;
00525         <span class="keywordtype">bool</span> ReturnValue=<span class="keyword">false</span>;
00526         <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00527         <span class="keywordflow">if</span> (pSource-&gt;<a class="code" href="structTImage.html#m3">Origin</a>==EMPTY)
00528         {
00529                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00530                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_RemoveRadialDistortion() Source image is empty - doing nothing"</span>);
00531                 ReturnValue=<span class="keyword">false</span>;
00532         }
00533         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pSource-&gt;<a class="code" href="structTImage.html#m6">Bits</a>!=8)
00534         {
00535                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00536                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_RemoveRadialDistortion() Image must be 8 b/p (current is %d b/p)"</span>,
00537                         pSource-&gt;<a class="code" href="structTImage.html#m6">Bits</a>);
00538                 ReturnValue=<span class="keyword">false</span>;
00539         }
00540         <span class="keywordflow">else</span> <span class="comment">/* Remove the radial distortion */</span>
00541         {
00542                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x,y;
00543                 <a class="code" href="structT2DInt.html">T2DInt</a> ImageCenter;
00544                 <a class="code" href="structT2DInt.html">T2DInt</a> TargetCenter;
00545                 <a class="code" href="structT2DFloat.html">T2DFloat</a> Pos;
00546                 <span class="comment">/* variable for the optimized k_InverseRadialMove functionality */</span>
00547                 <span class="keywordtype">double</span> x2;                      <span class="comment">/*  x^2        */</span>
00548                 <span class="keywordtype">double</span> y2;                      <span class="comment">/*  y^2        */</span>
00549                 <span class="keywordtype">double</span> x2y2;            <span class="comment">/*  x^2 + y^2  */</span>
00550                 <span class="keywordtype">double</span> MainDenominator; <span class="comment">/* common part of denominator used for calculating new values of both x and y */</span>
00551                 <span class="keywordtype">double</span> MainNumerator; <span class="comment">/* common part of numerator used for calculating new values of both x and y */</span>
00552                 <span class="keywordtype">double</span> y3;                      <span class="comment">/*  y^3        */</span>
00553                 <span class="keywordtype">double</span> kx2y2;
00554                 <span class="keywordtype">double</span> sqrtExp;
00555                 <span class="keywordtype">double</span> x2y2Pow1_5;
00556                 <span class="keywordtype">double</span> powParam;
00557                 <span class="keyword">const</span> <span class="keywordtype">double</span> k27=27*k;  <span class="comment">/*      27*k       */</span>
00558                 <span class="keyword">const</span> <span class="keywordtype">double</span> sqrtk=sqrt(k); <span class="comment">/* Sqrt(k)   */</span>
00559                 <span class="keyword">const</span> <span class="keywordtype">double</span> kPow1_5=pow(k,1.5);
00560                 <span class="keyword">const</span> <span class="keywordtype">double</span> sqrt3kPow1_5=CAL_SQRT3*kPow1_5;
00561                 <span class="keyword">const</span> <span class="keywordtype">double</span> n3Pow1_3t2=-2*CAL_N3POW1_3;
00562                 <span class="comment">/* end of k_InverseRadialMove variables */</span>
00563                 ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>=(short)<span class="comment">/*k_Round*/</span>(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
00564                 ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>=(short)<span class="comment">/*k_Round*/</span>(pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
00565                 <span class="comment">/* Check if the source and destination is the same image */</span>
00566                 <span class="keywordflow">if</span> (pDest==pSource)
00567                 {
00568                         pTarget=(<a class="code" href="structTImage.html">TImage</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structTImage.html">TImage</a>));
00569                         <a class="code" href="group__image.html#a1">k_InitImage</a>(pTarget);
00570                         CopyToSource=<span class="keyword">true</span>;
00571                 }
00572                 <span class="comment">/* calculate size of destination image and allocate memory */</span>
00573                 <span class="keywordflow">if</span> (PreserveImageSize==<span class="keyword">true</span>)
00574                         <a class="code" href="group__image.html#a2">k_AllocImage</a>(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>,pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>,8,pTarget);
00575                 <span class="keywordflow">else</span>
00576                 {
00577                         <a class="code" href="structT2DInt.html">T2DInt</a> MaxRadDispl;
00578                         MaxRadDispl=<a class="code" href="group__perspective.html#a7">k_GetMaxRadialDisplacement</a>(k,(<span class="keywordtype">float</span>)(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0),(<span class="keywordtype">float</span>)(pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0));
00579                         k_AllocImage(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>+2*MaxRadDispl.<a class="code" href="structT2DInt.html#m0">x</a>,pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>+2*MaxRadDispl.<a class="code" href="structT2DInt.html#m1">y</a>,8,pTarget);
00580                 }
00581                 TargetCenter.<a class="code" href="structT2DInt.html#m0">x</a>=(short)<span class="comment">/*k_Round*/</span>(pTarget-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
00582                 TargetCenter.<a class="code" href="structT2DInt.html#m1">y</a>=(short)<span class="comment">/*k_Round*/</span>(pTarget-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
00583                 <span class="keywordflow">if</span> (PreserveImageSize==<span class="keyword">false</span>)
00584                 {
00585                         <span class="comment">/* set border so no pixel access outside image is performed */</span>
00586                         <span class="keywordtype">double</span> by=(pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0)*pow(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0,2)*k;
00587                         <span class="keywordtype">double</span> bx=(pSource-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0)*pow(pSource-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0,2)*k;
00588                         bx&gt;by ? <a class="code" href="group__image.html#a20">k_SetBorder</a>((<a class="code" href="group__valuetypes.html#a3">UINT16</a>)(bx+1),0,pSource) : <a class="code" href="group__image.html#a20">k_SetBorder</a>((<a class="code" href="group__valuetypes.html#a3">UINT16</a>)(by+1),0,pSource);
00589                 }
00590                 <a class="code" href="group__image.html#a22">k_SetBorderColor</a>(255,pSource);
00591                 <span class="comment">/* Copy pixels to new image with radial correction */</span>
00592 <span class="comment">/*              for(x=0;x&lt;pTarget-&gt;Width;x++)</span>
00593 <span class="comment">                {</span>
00594 <span class="comment">                        for(y=0;y&lt;pTarget-&gt;Height;y++)</span>
00595 <span class="comment">                        {</span>
00596 <span class="comment">                                Pos=k_InverseRadialMove(((double)x)-TargetCenter.x,((double)y)-TargetCenter.y,k);</span>
00597 <span class="comment">                                Pos.x+=ImageCenter.x;</span>
00598 <span class="comment">                                Pos.y+=ImageCenter.y;</span>
00599 <span class="comment">                                k_SetPixel8bp(x,y,(unsigned int)(k_CalibGetPixelInterpolated8bp(Pos.x,Pos.y,pSource)+0.5),*pTarget);</span>
00600 <span class="comment">                        }</span>
00601 <span class="comment">                }*/</span>
00602                 <span class="keywordflow">for</span>(x=0;x&lt;(pTarget-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);x++)
00603                 {
00604                         x2=x*x;                 <span class="comment">/*  x^2        */</span>
00605                         <span class="keywordflow">for</span>(y=0;y&lt;(pTarget-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);y++)
00606                         {
00607                                 <span class="comment">/* calculate inverse radial move, it could be done with a call like shown below:</span>
00608 <span class="comment">                                   but for speed optimization, the code has been copied into this place. */</span>
00609                                 <span class="comment">/*Pos=k_InverseRadialMove(((double)x),((double)y),k);*/</span>
00610 
00611                                 <span class="comment">/* calculate sub-expressions */</span>
00612                                 y2=y*y;                 <span class="comment">/*  y^2        */</span>
00613                                 x2y2=x2+y2;             <span class="comment">/*  x^2 + y^2  */</span>
00614 
00615                                 <span class="keywordflow">if</span> (y==0) <span class="comment">/* special case */</span>
00616                                 {
00617                                         Pos.<a class="code" href="structT2DFloat.html#m0">x</a>= (float)((2*CAL_N3POW1_3-CAL_N2POW1_3*pow(-9*sqrtk*x+CAL_SQRT3*sqrt(4+k27*x2),CAL_FRAC2_3)) /
00618                                                 (CAL_N6POW2_3*sqrtk*pow(-9*sqrtk*x+CAL_SQRT3*sqrt(4+k27*x2),CAL_FRAC1_3)));
00619                                         Pos.<a class="code" href="structT2DFloat.html#m1">y</a>=0;
00620                                 }
00621                                 <span class="keywordflow">else</span>
00622                                 {
00623                                         y3=pow(y,3.0);  <span class="comment">/*  y^3        */</span>
00624                                         kx2y2=k*x2y2;
00625                                         sqrtExp=sqrt(4+k27*x2y2);
00626                                         x2y2Pow1_5=pow(x2y2,1.5);
00627                                         powParam=9*kx2y2*kx2y2*y3+sqrt3kPow1_5*y3*x2y2Pow1_5*sqrtExp;
00628                                         MainDenominator=n3Pow1_3t2*y2*kx2y2+CAL_N2POW1_3*pow(powParam,CAL_FRAC2_3);
00629                                         MainNumerator=CAL_N6POW2_3*kx2y2*pow(powParam,CAL_FRAC1_3);
00630                                         <span class="comment">/* Calculate the new y value */</span>
00631                                         Pos.<a class="code" href="structT2DFloat.html#m1">y</a>=(float)((MainDenominator)/(MainNumerator));
00632                                         <span class="comment">/* Calculate the new x value */</span>
00633                                         <span class="comment">/*Pos.x=(float)((x*MainDenominator)/(y*MainNumerator));*/</span>
00634                                         Pos.<a class="code" href="structT2DFloat.html#m0">x</a>=(float)(((double)x/y)*Pos.<a class="code" href="structT2DFloat.html#m1">y</a>);
00635                                         
00636                                 }
00637 
00638                                 <span class="comment">/* set a pixel value in each of the four quadrants in image */</span>
00639                                 <a class="code" href="group__image__c__only.html#a12">k_SetPixel8bp</a>(TargetCenter.<a class="code" href="structT2DInt.html#m0">x</a>+x,TargetCenter.<a class="code" href="structT2DInt.html#m1">y</a>+y,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(
00640                                         k_CalibGetPixelInterpolated8bp(ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>+Pos.<a class="code" href="structT2DFloat.html#m0">x</a>,ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>+Pos.<a class="code" href="structT2DFloat.html#m1">y</a>,pSource)+0.5),*pTarget);
00641                                 <a class="code" href="group__image__c__only.html#a12">k_SetPixel8bp</a>(TargetCenter.<a class="code" href="structT2DInt.html#m0">x</a>-x,TargetCenter.<a class="code" href="structT2DInt.html#m1">y</a>+y,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(
00642                                         k_CalibGetPixelInterpolated8bp(ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>-Pos.<a class="code" href="structT2DFloat.html#m0">x</a>,ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>+Pos.<a class="code" href="structT2DFloat.html#m1">y</a>,pSource)+0.5),*pTarget);
00643                                 <a class="code" href="group__image__c__only.html#a12">k_SetPixel8bp</a>(TargetCenter.<a class="code" href="structT2DInt.html#m0">x</a>-x,TargetCenter.<a class="code" href="structT2DInt.html#m1">y</a>-y,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(
00644                                         k_CalibGetPixelInterpolated8bp(ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>-Pos.<a class="code" href="structT2DFloat.html#m0">x</a>,ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>-Pos.<a class="code" href="structT2DFloat.html#m1">y</a>,pSource)+0.5),*pTarget);
00645                                 <a class="code" href="group__image__c__only.html#a12">k_SetPixel8bp</a>(TargetCenter.<a class="code" href="structT2DInt.html#m0">x</a>+x,TargetCenter.<a class="code" href="structT2DInt.html#m1">y</a>-y,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(
00646                                         k_CalibGetPixelInterpolated8bp(ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>+Pos.<a class="code" href="structT2DFloat.html#m0">x</a>,ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>-Pos.<a class="code" href="structT2DFloat.html#m1">y</a>,pSource)+0.5),*pTarget);
00647                         }
00648                 }
00649                 <span class="comment">/* copy image to source if destination and source is the same image */</span>
00650                 <span class="keywordflow">if</span> (CopyToSource==<span class="keyword">true</span>)
00651                 {
00652                         <a class="code" href="group__image.html#a24">k_CopyImage</a>(pDest,pTarget);
00653                         <a class="code" href="group__image.html#a0">k_EmptyImage</a>(pTarget);
00654                         free(pTarget);
00655                 }
00656                 ReturnValue=<span class="keyword">true</span>;
00657         }
00658         <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00659         <span class="keywordflow">return</span> ReturnValue;
00660 }
00661 
<a name="l00662"></a><a class="code" href="group__perspective.html#a9">00662</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a9">k_GetPosRadRemoved</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> x,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> y, <span class="keywordtype">double</span> k, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
00663 {
00664         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
00665         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> u=(FLOAT32)(x-CenterX);
00666         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> v=(FLOAT32)(y-CenterY);
00667         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>=x;
00668         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=y;
00669         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=(FLOAT32)k*u*(u*u+v*v);
00670         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=(FLOAT32)k*v*(u*u+v*v);
00671         <span class="keywordflow">return</span> NewPos;
00672 }
00673 
<a name="l00674"></a><a class="code" href="group__perspective.html#a10">00674</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a10">k_GetPosInverseRad</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> xr, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> yr, <span class="keywordtype">double</span> k, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
00675 {
00676         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
00677         NewPos=k_InverseRadialMove(((<span class="keywordtype">double</span>)xr)-CenterX,((<span class="keywordtype">double</span>)yr)-CenterY,k);
00678         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=CenterX;
00679         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=CenterY;
00680         <span class="keywordflow">return</span> NewPos;
00681 }
00682 
<a name="l00683"></a><a class="code" href="group__perspective.html#a11">00683</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a11">k_PrintCameraMatrix</a>(<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <span class="keywordtype">bool</span> WithIndexes)
00684 {
00685         printf(<span class="stringliteral">"**************** TCameraMatrix info ********************\n"</span>);
00686         <span class="keywordflow">if</span> (WithIndexes==<span class="keyword">true</span>)
00687         {
00688                 printf(<span class="stringliteral">" a11=% .4e a12=% .4e a13=% .4e a14=% .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>);
00689                 printf(<span class="stringliteral">" a21=% .4e a22=% .4e a23=% .4e a24=% .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>);
00690                 printf(<span class="stringliteral">" a31=% .4e a32=% .4e a33=% .4e a34=% .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m8">a31</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m9">a32</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m10">a33</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m11">a34</a>);
00691                 printf(<span class="stringliteral">" a41=% .4e a42=% .4e a43=% .4e a44=% .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m15">a44</a>);
00692         }
00693         <span class="keywordflow">else</span>
00694         {
00695                 printf(<span class="stringliteral">" % .4e % .4e % .4e % .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>);
00696                 printf(<span class="stringliteral">" % .4e % .4e % .4e % .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>);
00697                 printf(<span class="stringliteral">" % .4e % .4e % .4e % .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m8">a31</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m9">a32</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m10">a33</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m11">a34</a>);
00698                 printf(<span class="stringliteral">" % .4e % .4e % .4e % .4e\n"</span>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>,pMat-&gt;<a class="code" href="structTCameraMatrix.html#m15">a44</a>);
00699         }
00700 }
00701 
<a name="l00702"></a><a class="code" href="group__perspective.html#a12">00702</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a12">k_MatrixToParameters</a>(<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <a class="code" href="structTCameraParameters.html">TCameraParameters</a>* pPar)
00703 {
00704         <span class="keywordtype">double</span> den,sqrtden;
00705         <span class="keywordtype">bool</span> k23positive;
00706         <span class="keywordtype">double</span> a0,a1;
00707         <span class="keywordtype">double</span> b0,b1;
00708         <span class="keywordtype">int</span> TrueSolutions;
00709         <span class="keywordtype">double</span> test1,test2,test3,test4;
00710         <span class="keywordtype">double</span> err1,err2,err3,err4;
00711         <span class="keywordtype">double</span> ctemp;
00712         <span class="keywordtype">double</span> c0,c1;
00713         <span class="keywordtype">double</span> beta0,beta1,beta2,beta3;
00714         <span class="keywordtype">double</span> n,m,nom,det;
00715         <span class="keywordtype">double</span> c00,c01,c02,c03;
00716         <span class="keywordtype">double</span> c10,c11,c12,c13;
00717         <span class="keywordtype">double</span> c20,c21,c22;
00718         <span class="keywordtype">double</span> ZeroThreshold = 1.0e-5;
00719 
00720         c00=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>;  c01=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>;  c02=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>;  c03=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>;
00721         c10=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>;  c11=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>;  c12=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>;  c13=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>;
00722         c20=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>;  c21=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>;  c22=pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>;
00723 
00724         <span class="comment">/* Focal centre (dx,dy,dz) */</span>
00725         den =           c02*c11*c20 - c01*c12*c20 - c02*c10*c21 +
00726                         c00*c12*c21 + c01*c10*c22 - c00*c11*c22;
00727 
00728         pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> =      (-c02*c11 + c01*c12 - c03*c12*c21 +
00729                         c02*c13*c21 + c03*c11*c22 - c01*c13*c22)/ den;
00730 
00731         pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a> =      (c02*c10 - c00*c12 + c03*c12*c20 - c02*c13*c20
00732                         - c03*c10*c22 + c00*c13*c22)/ den;
00733 
00734         pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a> =      (c00*c11 - c03*c11*c20 - c01*(c10 - c13*c20)
00735                         + c03*c10*c21 - c00*c13*c21)/ den;
00736 
00737         <span class="comment">/* temporary results */</span>
00738         den = c20*c20 + c21*c21 + c22*c22;
00739         sqrtden = sqrt(den);
00740 
00741         <span class="comment">/* Origin (xh,yh) of image plane on the CCD chip measured in pixels */</span>
00742         pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a> = (c00*c20 + c01*c21 + c02*c22) / den;
00743         pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a> = (c10*c20 + c11*c21 + c12*c22) / den;
00744 
00745         <span class="comment">/* Focal lenght = 1/f measured in pixels */</span>
00746         pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a> = 1 / sqrt((c00*c00 + c01*c01 + c02*c02) / den - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>);
00747                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m7">FocalLength</a>=1/pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>; <span class="comment">/* added by edr@mip.sdu.dk 21/5/2000 */</span>
00748 
00749         <span class="comment">/* Aspect ratio, defined as scale of V relative to U */</span>
00750         pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a> = pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a> * sqrt((c10*c10 + c11*c11 + c12*c12) / den - pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>);
00751 
00752         <span class="comment">/* External angles (a,b,c) */</span>
00753         <span class="comment">/* angle a and b */</span>
00754         a0 = atan(-c21 / c22);
00755         a1 = a0 + <a class="code" href="group__c__globals.html#a0">PI</a>;
00756 
00757         b0 = asin(-c20 / sqrtden);
00758         b1 = asin(c20 / sqrtden);
00759 
00760         test1 = -sin(b0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> + cos(b0)*sin(a0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a> - cos(b0)*cos(a0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00761         test2 = -sin(b1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> + cos(b1)*sin(a0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a> - cos(b1)*cos(a0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00762         test3 = -sin(b0)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> + cos(b0)*sin(a1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a> - cos(b0)*cos(a1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00763         test4 = -sin(b1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> + cos(b1)*sin(a1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a> - cos(b1)*cos(a1)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00764         err1 = fabs(test1) - 1/sqrtden;
00765         err2 = fabs(test2) - 1/sqrtden;
00766         err3 = fabs(test3) - 1/sqrtden;
00767         err4 = fabs(test4) - 1/sqrtden;
00768 
00769         TrueSolutions = 0;
00770         <span class="keywordflow">if</span>((test1 &gt; 0)&amp;&amp;(fabs(err1) &lt; ZeroThreshold))
00771         {
00772                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a> = a0;
00773                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a> = b0;
00774                 k23positive = <span class="keyword">true</span>;
00775                 TrueSolutions = TrueSolutions+1;
00776         }
00777         <span class="keywordflow">if</span>((test2 &gt; 0)&amp;&amp;(fabs(err2) &lt; ZeroThreshold))
00778         {
00779                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a> = a0;
00780                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a> = b1;
00781                 k23positive = <span class="keyword">false</span>;
00782                 TrueSolutions = TrueSolutions+1;
00783         }
00784         <span class="keywordflow">if</span>((test3 &gt; 0)&amp;&amp;(fabs(err3) &lt; ZeroThreshold))
00785         {
00786                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a> = a1;
00787                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a> = b0;
00788                 k23positive = <span class="keyword">true</span>;
00789                 TrueSolutions = TrueSolutions+1;
00790         }
00791         <span class="keywordflow">if</span>((test4 &gt; 0)&amp;&amp;(fabs(err4) &lt; ZeroThreshold))
00792         {
00793                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a> = a1;
00794                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a> = b1;
00795                 k23positive = <span class="keyword">false</span>;
00796                 TrueSolutions = TrueSolutions+1;
00797         }
00798         <span class="keywordflow">if</span>(TrueSolutions == 0)
00799         {
00800                 <a class="code" href="structTString.html">TString</a> str;
00801                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00802                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00803                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_MatrixToParameters() No true solution found for angle a and b"</span>);
00804                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00805                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00806         }
00807         <span class="keywordflow">if</span>(TrueSolutions &gt; 1)
00808         {
00809                 <a class="code" href="structTString.html">TString</a> str;
00810                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00811                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00812                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_MatrixToParameters() More solutions found for angle a and b"</span>);
00813                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00814         }
00815 
00816         <span class="comment">/* angle c */</span>
00817         ctemp = atan((c02*c21 - c01*c22) / (sqrtden * (c00 - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*c20)));
00818 
00819         <span class="keywordflow">if</span>(k23positive)
00820         {
00821                 c0 = ctemp;
00822                 c1 = ctemp + <a class="code" href="group__c__globals.html#a0">PI</a>;
00823         }
00824         <span class="keywordflow">else</span>
00825         {
00826                 c0 = -ctemp;
00827                 c1 = -ctemp - <a class="code" href="group__c__globals.html#a0">PI</a>;
00828         }
00829 
00830         test1 =  (cos(c0)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>) - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>
00831                 +(sin(c0)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>) + sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(c0)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00832                 + pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>
00833                 +(sin(c0)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>) - cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(c0)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00834                 - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00835         test2 =  (cos(c1)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>) - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>
00836                 +(sin(c1)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>) + sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(c1)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00837                 + pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>
00838                 +(sin(c1)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>) - cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(c1)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00839                 - pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)) * pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>;
00840         err1 = fabs(test1) - fabs(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>/sqrtden * c03);
00841         err2 = fabs(test2) - fabs(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>/sqrtden * c03);
00842 
00843         TrueSolutions = 0;
00844         <span class="keywordflow">if</span>(fabs(err1) &lt; ZeroThreshold)
00845         {
00846                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a> = c0;
00847                 TrueSolutions = TrueSolutions+1;
00848         }
00849         <span class="keywordflow">if</span>(fabs(err2) &lt; ZeroThreshold)
00850         {
00851                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a> = c1;
00852                 TrueSolutions = TrueSolutions+1;
00853         }
00854         <span class="keywordflow">if</span>(TrueSolutions == 0)
00855         {
00856                 <a class="code" href="structTString.html">TString</a> str;
00857                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00858                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00859                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_MatrixToParameters() No true solution found for angle c"</span>);
00860                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00861                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00862         }
00863         <span class="keywordflow">if</span>(TrueSolutions &gt; 1)
00864         {
00865                 <a class="code" href="structTString.html">TString</a> str;
00866                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00867                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00868                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_MatrixToParameters() More solutions found for angle c"</span>);
00869                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00870         }
00871 
00872         <span class="comment">/* Skewness of V relative to U */</span>
00873         nom = pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*(sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a> - cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>
00874                 + cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>);
00875         det = - c02*c11*c20 + c01*c12*c20
00876               + c02*c10*c21 - c00*c12*c21
00877               - c01*c10*c22 + c00*c11*c22;
00878         n = tan(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>);
00879         m = (cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*c11 + sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*c12)/(pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>))*nom;
00880 
00881         beta0 = acos(-(fabs(det)*nom*nom*nom)/(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>));
00882         beta1 = -beta0;
00883         beta2 = 2*atan((n + sqrt(1 + n*n - m*m))/(1 + m));
00884         beta3 = 2*atan((n - sqrt(1 + n*n - m*m))/(1 + m));
00885         err1 = fabs(beta0-beta2);
00886         err2 = fabs(beta0-beta3);
00887         err3 = fabs(beta1-beta2);
00888         err4 = fabs(beta1-beta3);
00889 
00890         TrueSolutions = 0;
00891         <span class="keywordflow">if</span>((fabs(err1) &lt; ZeroThreshold)||(fabs(fabs(err1)-<a class="code" href="group__c__globals.html#a0">PI</a>) &lt; ZeroThreshold))
00892         {
00893                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> = beta0;
00894                 TrueSolutions = TrueSolutions+1;
00895         }
00896         <span class="keywordflow">if</span>((fabs(err2) &lt; ZeroThreshold)||(fabs(fabs(err2)-<a class="code" href="group__c__globals.html#a0">PI</a>) &lt; ZeroThreshold))
00897         {
00898                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> = beta0;
00899                 TrueSolutions = TrueSolutions+1;
00900         }
00901         <span class="keywordflow">if</span>((fabs(err3) &lt; ZeroThreshold)||(fabs(fabs(err3)-<a class="code" href="group__c__globals.html#a0">PI</a>) &lt; ZeroThreshold))
00902         {
00903                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> = beta1;
00904                 TrueSolutions = TrueSolutions+1;
00905         }
00906         <span class="keywordflow">if</span>((fabs(err4) &lt; ZeroThreshold)||(fabs(fabs(err4)-<a class="code" href="group__c__globals.html#a0">PI</a>) &lt; ZeroThreshold))
00907         {
00908                 pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> = beta1;
00909                 TrueSolutions = TrueSolutions+1;
00910         }
00911         <span class="keywordflow">if</span>(TrueSolutions == 0)
00912         {
00913                 <a class="code" href="structTString.html">TString</a> str;
00914                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00915                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00916                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_MatrixToParameters() No true solution found for angle beta"</span>);
00917                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00918                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00919         }
00920         <span class="keywordflow">if</span>(TrueSolutions &gt; 1)
00921         {
00922                 <a class="code" href="structTString.html">TString</a> str;
00923                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00924                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00925                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_MatrixToParameters() More solutions found for angle beta"</span>);
00926                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00927         }
00928         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00929 }
00930 
00931 
<a name="l00932"></a><a class="code" href="group__perspective.html#a13">00932</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a13">k_ParametersToMatrix</a>(<span class="keyword">const</span> <a class="code" href="structTCameraParameters.html">TCameraParameters</a>* pPar, <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat)
00933 {
00934         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> a44;
00935         <span class="keywordflow">if</span>(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>==0.0)
00936         {
00937                 <a class="code" href="structTString.html">TString</a> str;
00938                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00939                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00940                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_ParametersToMatrix() Camera matrix undefined for f=0.0"</span>);
00941                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00942                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00943         }
00944         <span class="keywordflow">if</span>((pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>==0.0) &amp;&amp; (pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>==0.0) &amp;&amp; (pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>==0.0))
00945         {
00946                 <a class="code" href="structTString.html">TString</a> str;
00947                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00948                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00949                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_ParametersToMatrix() Camera matrix undefined for dx=0.0, dy=0.0 and dz=0.0"</span>);
00950                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00951                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00952         }
00953         <span class="keywordflow">if</span>((pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>==<a class="code" href="group__c__globals.html#a0">PI</a>) &amp;&amp; (pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>==0.0))
00954         {
00955                 <a class="code" href="structTString.html">TString</a> str;
00956                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
00957                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
00958                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_ParametersToMatrix() Camera matrix undefined for b=Pi and dx=0.0o"</span>);
00959                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
00960                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00961         }
00962         <span class="comment">/* building unnormalized transformation matrix */</span>
00963         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a> =     (FLOAT32)(cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)
00964                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>));
00965         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a> =     (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)
00966                         + cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00967                         + cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>));
00968         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a> =     (FLOAT32)(-(cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00969                         + cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)))
00970                         + sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>));
00971         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a> =     (FLOAT32)(-(cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)
00972                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)))
00973                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00974                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00975                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)
00976                         + cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00977                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00978                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)));
00979         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a> =     (FLOAT32)(-(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>))
00980                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>));
00981         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a> =     (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)
00982                         + sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00983                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)));
00984         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a> =     (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)
00985                         - cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00986                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)));
00987         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a> =     (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00988                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)
00989                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)
00990                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)
00991                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
00992                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>) + (-(pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>))
00993                         + pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>))
00994                         *sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>))*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a> - pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>));
00995         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a> =     (FLOAT32)(-(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)));
00996         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a> =     (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>));
00997         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a> =     (FLOAT32)(-(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)));
00998 
00999         a44 =           (FLOAT32)(pPar-&gt;<a class="code" href="structTCameraParameters.html#m6">f</a>*(pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>)*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)
01000                         - pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>*cos(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>) + pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>*sin(pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>)));
01001 
01002         <span class="comment">/* normalizing matrix */</span>
01003         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m0">a11</a>/a44;
01004         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m1">a12</a>/a44;
01005         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m2">a13</a>/a44;
01006         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m3">a14</a>/a44;
01007         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m4">a21</a>/a44;
01008         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m5">a22</a>/a44;
01009         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m6">a23</a>/a44;
01010         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m7">a24</a>/a44;
01011         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m12">a41</a>/a44;
01012         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m13">a42</a>/a44;
01013         pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a> = pMat-&gt;<a class="code" href="structTCameraMatrix.html#m14">a43</a>/a44;
01014 
01015         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01016 }
01017 
<a name="l01018"></a><a class="code" href="group__perspective.html#a14">01018</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a14">k_PrintCameraParameterInfo</a>(<span class="keyword">const</span> <a class="code" href="structTCameraParameters.html">TCameraParameters</a>* pPar)
01019 {
01020         printf(<span class="stringliteral">"**************** TCameraParameters info ********************\n"</span>);
01021         printf(<span class="stringliteral">"x coordinate of focal centre (dx) = % .4f \n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m0">dx</a>);
01022         printf(<span class="stringliteral">"y coordinate of focal centre (dy) = % .4f \n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m1">dy</a>);
01023         printf(<span class="stringliteral">"z coordinate of focal centre (dz) = % .4f \n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m2">dz</a>);
01024         printf(<span class="stringliteral">"rotation of camera around the x-axis (a) = % .4f [rad] = % .4f [deg]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m3">a</a>*180.0/<a class="code" href="group__c__globals.html#a0">PI</a>);
01025         printf(<span class="stringliteral">"rotation of camera around the y-axis (b) = % .4f [rad] = % .4f [deg]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m4">b</a>*180.0/<a class="code" href="group__c__globals.html#a0">PI</a>);
01026         printf(<span class="stringliteral">"rotation of camera around the z-axis (c) = % .4f [rad] = % .4f [deg]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m5">c</a>*180.0/<a class="code" href="group__c__globals.html#a0">PI</a>);
01027         printf(<span class="stringliteral">"focal length = % .4f [pixels]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m7">FocalLength</a>);
01028         printf(<span class="stringliteral">"x-coordinate of origin of the focal centre on the CCD chip (xh) = % .4f [pixels]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m8">xh</a>);
01029         printf(<span class="stringliteral">"y-coordinate of origin of the focal centre on the CCD chip (yh) = % .4f [pixels]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m9">yh</a>);
01030         printf(<span class="stringliteral">"aspect ratio, scale of V relative to U (p) = % .4f \n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m10">p</a>);
01031         printf(<span class="stringliteral">"skewness of V relative to U (beta) =  %. 4f [rad] = % .4f [deg]\n"</span>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a>,pPar-&gt;<a class="code" href="structTCameraParameters.html#m11">beta</a>*180.0/<a class="code" href="group__c__globals.html#a0">PI</a>);
01032 }
01033 
01034 <span class="comment">/************************************************/</span>
01035 <span class="comment">/********        Private functions       ********/</span>
01036 <span class="comment">/************************************************/</span>
01037 
01038 <span class="keywordtype">void</span> k_LinEq(<span class="keywordtype">int</span> n, <span class="keywordtype">double</span>**Coef, <span class="keywordtype">double</span>*Right, <span class="keywordtype">double</span>*Res)
01039 {
01040         <span class="keywordtype">int</span>* r=(<span class="keywordtype">int</span>*)calloc(n, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
01041         <span class="keywordtype">int</span> i,j,k,m,temp;
01042         <span class="keywordtype">double</span> max, buf;
01043         <span class="keywordflow">for</span>(i=0;i&lt;n;i++)
01044         {
01045                 r[i]=i;
01046         }
01047         <span class="keywordflow">for</span>(k=0;k&lt;n-1;k++)
01048         {
01049                 max=0;
01050                 <span class="keywordflow">for</span> (i=k;i&lt;n;i++)
01051                 {
01052                         <span class="keywordflow">if</span> (fabs(Coef[r[i]][k])&gt;max)
01053                         {
01054                                 max=Coef[r[i]][k];
01055                                 m=i;
01056                         }
01057                 }
01058                 <span class="keywordflow">if</span> (m&gt;k)
01059                 {
01060                         temp=r[k];
01061                         r[k]=r[m];
01062                         r[m]=temp;
01063                 }
01064                 <span class="keywordflow">for</span> (i=k+1;i&lt;n;i++)
01065                 {
01066                         buf=Coef[r[i]][k];
01067                         <span class="keywordflow">if</span> (buf!=0)
01068                         {
01069                                 buf=buf/Coef[r[k]][k];
01070                                 <span class="keywordflow">for</span> (j=k+1;j&lt;n;j++){
01071                                         Coef[r[i]][j]=Coef[r[i]][j]-buf*Coef[r[k]][j];
01072                                 }
01073                                 Right[r[i]]=Right[r[i]]-buf*Right[r[k]];
01074                         }
01075                 }
01076         }
01077         Res[n-1]=Right[r[n-1]]/Coef[r[n-1]][n-1];
01078         <span class="keywordflow">for</span> (i=n-2;i&gt;=0;i--)
01079         {
01080                 buf=Right[r[i]];
01081                 <span class="keywordflow">for</span> (j=i+1;j&lt;n;j++){
01082                         buf=buf-Coef[r[i]][j]*Res[j];
01083                 }
01084                 Res[i]=buf/Coef[r[i]][i];
01085         }
01086         free(r);
01087 }
01088 
01089 <span class="keywordtype">double</span> k_RadialCalibAndGetMeanError(<a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> *pPointSets,<span class="keywordtype">double</span> k,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
01090 {
01091         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
01092         <span class="keywordtype">double</span> ReturnValue;
01093         <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a> Mat;
01094         <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> NewPointSets; <span class="comment">/* used to hold the new Ccd 2D coordinates */</span>
01095         <a class="code" href="group__corresponding3d2dpoints.html#a0">k_Init3D2DPoints</a>(&amp;NewPointSets);
01096         <a class="code" href="group__corresponding3d2dpoints.html#a8">k_Copy3D2DPoints</a>(&amp;NewPointSets,pPointSets);
01097         <span class="keywordflow">for</span>(i=0; i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
01098         {
01099                 <a class="code" href="structT2DFloat.html">T2DFloat</a> P2d;
01100                 P2d=<a class="code" href="group__perspective.html#a9">k_GetPosRadRemoved</a>(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>,k,CenterX,CenterY);
01101                 <a class="code" href="group__corresponding3d2dpoints.html#a18">k_SetPoint2DIn3D2DPoints</a>(&amp;P2d,i,&amp;NewPointSets);
01102         }
01103         <a class="code" href="group__perspective.html#a1">k_CalibrateCamera</a>(&amp;NewPointSets,&amp;Mat);
01104         ReturnValue=k_GetMeanError(&amp;NewPointSets,&amp;Mat);
01105         <a class="code" href="group__corresponding3d2dpoints.html#a1">k_Empty3D2DPoints</a>(&amp;NewPointSets);
01106         <span class="keywordflow">return</span> ReturnValue;
01107 }
01108 
01109 <span class="preprocessor">#define CALIB_R 0.61803399</span>
01110 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_C (1.0-CALIB_R)</span>
01111 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_SHFT2(a,b,c) (a)=(b);(b)=(c);</span>
01112 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_SHFT3(a,b,c,d) (a)=(b);(b)=(c);(c)=(d);</span>
01113 <span class="preprocessor"></span><span class="keywordtype">double</span> k_CalibGoldenSearch(<span class="keywordtype">double</span> ax,<span class="keywordtype">double</span> bx,<span class="keywordtype">double</span> cx,<span class="keywordtype">double</span> tol,<span class="keywordtype">double</span> *xmin,
01114                                                   <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY)
01115 {
01116         <span class="keywordtype">double</span> f1,f2,x0,x1,x2,x3;
01117         x0=ax;
01118         x3=cx;
01119         <span class="keywordflow">if</span> (fabs(cx-bx)&gt;fabs(bx-ax))
01120         {
01121                 x1=bx;
01122                 x2=bx+CALIB_C*(cx-bx);
01123         }
01124         <span class="keywordflow">else</span>
01125         {
01126                 x2=bx;
01127                 x1=bx-CALIB_C*(bx-ax);
01128         }
01129         f1=k_RadialCalibAndGetMeanError(pPointSets,x1,CenterX,CenterY);
01130         f2=k_RadialCalibAndGetMeanError(pPointSets,x2,CenterX,CenterY);
01131         <span class="keywordflow">while</span> ((fabs(x3-x0) &gt; tol*(fabs(x1)+fabs(x2))) &amp;&amp; (x1&gt;1e-15)) <span class="comment">// last check by edr - stop if k gets very small</span>
01132         {
01133                 <span class="keywordtype">double</span> test1=fabs(x3-x0);
01134                 <span class="keywordtype">double</span> test2=tol*(fabs(x1)+fabs(x2));
01135                 <span class="keywordflow">if</span> (f2&lt;f1)
01136                 {
01137                         CALIB_SHFT3(x0,x1,x2,CALIB_R*x1+CALIB_C*x3)
01138                         CALIB_SHFT2(f1,f2,k_RadialCalibAndGetMeanError(pPointSets,x2,CenterX,CenterY))
01139                 }
01140                 <span class="keywordflow">else</span>
01141                 {
01142                         CALIB_SHFT3(x3,x2,x1,CALIB_R*x2+CALIB_C*x0)
01143                         CALIB_SHFT2(f2,f1,k_RadialCalibAndGetMeanError(pPointSets,x1,CenterX,CenterY))
01144                 }
01145         }
01146         <span class="keywordflow">if</span> (f1&lt;f2)
01147         {
01148                 *xmin=x1;
01149                 <span class="keywordflow">return</span> f1;
01150         }
01151         <span class="keywordflow">else</span>
01152         {
01153                 *xmin=x2;
01154                 <span class="keywordflow">return</span> f2;
01155         }
01156 }
01157 
01158 <span class="keywordtype">double</span> k_GetMeanError(<span class="keyword">const</span> <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets,<span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat)
01159 {
01160         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
01161         <a class="code" href="structT2DFloat.html">T2DFloat</a> point;
01162         <span class="keywordtype">double</span> XErrorSum=0;
01163         <span class="keywordtype">double</span> YErrorSum=0;
01164         <span class="comment">/*printf("In k_GetMeanError()\n");*/</span>
01165         <span class="keywordflow">for</span>(i=0; i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
01166         {
01167                 <a class="code" href="group__perspective.html#a2">k_Calc3DTo2D</a>(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m0">Pnt3D</a>,pMat,&amp;point);
01168                 XErrorSum+=fabs(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>-point.<a class="code" href="structT2DFloat.html#m0">x</a>);
01169                 YErrorSum+=fabs(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>-point.<a class="code" href="structT2DFloat.html#m1">y</a>);
01170                 <span class="comment">/*printf("  Point 0 at (%f,%f) Error: (%f,%f)\n",pPointSets-&gt;pSet[i].Pnt2D.x,pPointSets-&gt;pSet[i].Pnt2D.y,</span>
01171 <span class="comment">                                pPointSets-&gt;pSet[i].Pnt2D.x-point.x,pPointSets-&gt;pSet[i].Pnt2D.y-point.y);*/</span>
01172         }
01173         <span class="keywordflow">return</span> (double)((XErrorSum+YErrorSum)/(2.0*i));
01174 }
01175 
01176 <a class="code" href="structT2DFloat.html">T2DFloat</a> k_InverseRadialMove(<span class="keywordtype">double</span> xr, <span class="keywordtype">double</span> yr,<span class="keywordtype">double</span> k)
01177 {
01178 
01179         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos; <span class="comment">/* the new position to be returned */</span>
01180 
01181         <span class="keywordtype">double</span> x=fabs(xr); <span class="comment">/* nummerical value of xr */</span>
01182         <span class="keywordtype">double</span> y=fabs(yr); <span class="comment">/* nummerical value of yr */</span>
01183 
01184         <span class="comment">/* calculate sub-expressions */</span>
01185         <span class="keywordtype">double</span> x2=x*x;                  <span class="comment">/*  y^2        */</span>
01186         <span class="keywordtype">double</span> y2=y*y;                  <span class="comment">/*  y^2        */</span>
01187         <span class="keywordtype">double</span> x2y2=x2+y2;              <span class="comment">/*  x^2 + y^2  */</span>
01188 
01189         <span class="keywordtype">double</span> MainDenominator; <span class="comment">/* common part of denominator used for calculating new values of both x and y */</span>
01190         <span class="keywordtype">double</span> MainNumerator; <span class="comment">/* common part of numerator used for calculating new values of both x and y */</span>
01191 
01192         <span class="keywordflow">if</span> (yr==0) <span class="comment">/* special case */</span>
01193         {
01194                 NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>= (float)((2*CAL_N3POW1_3-CAL_N2POW1_3*pow(-9*sqrt(k)*x+CAL_SQRT3*sqrt(4+27*k*x2),CAL_FRAC2_3)) /
01195                         (CAL_N6POW2_3*sqrt(k)*pow(-9*sqrt(k)*x+CAL_SQRT3*sqrt(4+27*k*x2),CAL_FRAC1_3)));
01196                 NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=0;
01197         }
01198         <span class="keywordflow">else</span>
01199         {
01200                 <span class="comment">/* Could save 4 * operations and 1 pow() when k is constant! */</span>
01201                 <span class="keywordtype">double</span> y3=pow(y,3);     <span class="comment">/*  y^3        */</span>
01202                 <span class="keywordtype">double</span> kx2y2=k*x2y2;
01203                 <span class="keywordtype">double</span> sqrtExp=sqrt(4+27*k*x2y2);
01204                 <span class="keywordtype">double</span> kPow1_5=pow(k,1.5);
01205                 <span class="keywordtype">double</span> x2y2Pow1_5=pow(x2y2,1.5);
01206                 <span class="keywordtype">double</span> powParam=9*kx2y2*kx2y2*y3+CAL_SQRT3*kPow1_5*y3*x2y2Pow1_5*sqrtExp;
01207                 MainDenominator=-2*CAL_N3POW1_3*y2*kx2y2+CAL_N2POW1_3*pow(powParam,CAL_FRAC2_3);
01208                 MainNumerator=CAL_N6POW2_3*kx2y2*pow(powParam,CAL_FRAC1_3);
01209                 <span class="comment">/* Calculate the new x value */</span>
01210                 NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>=(float)((x*MainDenominator)/(y*MainNumerator));
01211 
01212                 <span class="comment">/* Calculate the new y value */</span>
01213                 NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=(float)((MainDenominator)/(MainNumerator));
01214         }
01215         <span class="keywordflow">if</span> (x!=xr)
01216                 NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>=-NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>;
01217         <span class="keywordflow">if</span> (y!=yr)
01218                 NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=-NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>;
01219         <span class="keywordflow">return</span> NewPos;
01220 }
01221 
01222 <span class="keywordtype">float</span> k_CalibGetPixelInterpolated8bp(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pInfo)
01223 {
01224         <span class="keywordtype">int</span> xl = (x &gt;=0 ? (int)x : (int)(x-1)); <span class="comment">/* always round down */</span>
01225         <span class="keywordtype">int</span> yl = (y &gt;=0 ? (int)y : (int)(y-1)); <span class="comment">/* always round down */</span>
01226         <span class="comment">/* lower right pixel (h ~ high) */</span>
01227         <span class="keywordtype">int</span> xh = xl + 1;
01228         <span class="keywordtype">int</span> yh = yl + 1;
01229         <span class="comment">/* do bilinear interpolation */</span>
01230         <span class="keywordflow">return</span> ((<a class="code" href="group__image__c__only.html#a9">k_GetPixel8bp</a>(xl,yl,(*pInfo))*((float)xh-x) + <a class="code" href="group__image__c__only.html#a9">k_GetPixel8bp</a>(xh,yl,(*pInfo))*(x-(float)xl))*((float)yh-y) +
01231          (<a class="code" href="group__image__c__only.html#a9">k_GetPixel8bp</a>(xl,yh,(*pInfo))*((float)xh-x) + <a class="code" href="group__image__c__only.html#a9">k_GetPixel8bp</a>(xh,yh,(*pInfo))*(x-(float)xl))*(y-(float)yl));
01232 }
01233 
01234 
01235 <span class="comment">/************************************************/</span>
01236 <span class="comment">/********         Old functions          ********/</span>
01237 <span class="comment">/***** only kept for backward compatibility *****/</span>
01238 <span class="comment">/************************************************/</span>
01239 
01240 <span class="keywordtype">double</span> k_RadialCalibAndGetMeanErrorOld(<a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> *pPointSets,<span class="keywordtype">double</span> k,<span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg)
01241 {
01242         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
01243         <span class="keywordtype">double</span> ReturnValue;
01244         <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a> Mat;
01245         <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> NewPointSets; <span class="comment">/* used to hold the new Ccd 2D coordinates */</span>
01246         <a class="code" href="group__corresponding3d2dpoints.html#a0">k_Init3D2DPoints</a>(&amp;NewPointSets);
01247         <a class="code" href="group__corresponding3d2dpoints.html#a8">k_Copy3D2DPoints</a>(&amp;NewPointSets,pPointSets);
01248         <span class="keywordflow">for</span>(i=0; i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
01249         {
01250                 <a class="code" href="structT2DFloat.html">T2DFloat</a> P2d;
01251                 P2d=<a class="code" href="group__perspective.html#a18">k_GetPosRadRemovedOld</a>(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>,pImg,k);
01252                 <a class="code" href="group__corresponding3d2dpoints.html#a18">k_SetPoint2DIn3D2DPoints</a>(&amp;P2d,i,&amp;NewPointSets);
01253         }
01254         <a class="code" href="group__perspective.html#a1">k_CalibrateCamera</a>(&amp;NewPointSets,&amp;Mat);
01255         ReturnValue=k_GetMeanError(&amp;NewPointSets,&amp;Mat);
01256         <a class="code" href="group__corresponding3d2dpoints.html#a1">k_Empty3D2DPoints</a>(&amp;NewPointSets);
01257         <span class="keywordflow">return</span> ReturnValue;
01258 }
01259 
01260 <span class="preprocessor">#define CALIB_R 0.61803399</span>
01261 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_C (1.0-CALIB_R)</span>
01262 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_SHFT2(a,b,c) (a)=(b);(b)=(c);</span>
01263 <span class="preprocessor"></span><span class="preprocessor">#define CALIB_SHFT3(a,b,c,d) (a)=(b);(b)=(c);(c)=(d);</span>
01264 <span class="preprocessor"></span><span class="keywordtype">double</span> k_CalibGoldenSearchOld(<span class="keywordtype">double</span> ax,<span class="keywordtype">double</span> bx,<span class="keywordtype">double</span> cx,<span class="keywordtype">double</span> tol,<span class="keywordtype">double</span> *xmin,
01265                                                   <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets,<span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg)
01266 {
01267         <span class="keywordtype">double</span> f1,f2,x0,x1,x2,x3;
01268         x0=ax;
01269         x3=cx;
01270         <span class="keywordflow">if</span> (fabs(cx-bx)&gt;fabs(bx-ax))
01271         {
01272                 x1=bx;
01273                 x2=bx+CALIB_C*(cx-bx);
01274         }
01275         <span class="keywordflow">else</span>
01276         {
01277                 x2=bx;
01278                 x1=bx-CALIB_C*(bx-ax);
01279         }
01280         f1=k_RadialCalibAndGetMeanErrorOld(pPointSets,x1,pImg);
01281         f2=k_RadialCalibAndGetMeanErrorOld(pPointSets,x2,pImg);
01282         <span class="keywordflow">while</span> (fabs(x3-x0) &gt; tol*(fabs(x1)+fabs(x2)))
01283         {
01284                 <span class="keywordflow">if</span> (f2&lt;f1)
01285                 {
01286                         CALIB_SHFT3(x0,x1,x2,CALIB_R*x1+CALIB_C*x3)
01287                         CALIB_SHFT2(f1,f2,k_RadialCalibAndGetMeanErrorOld(pPointSets,x2,pImg))
01288                 }
01289                 <span class="keywordflow">else</span>
01290                 {
01291                         CALIB_SHFT3(x3,x2,x1,CALIB_R*x2+CALIB_C*x0)
01292                         CALIB_SHFT2(f2,f1,k_RadialCalibAndGetMeanErrorOld(pPointSets,x1,pImg))
01293                 }
01294         }
01295         <span class="keywordflow">if</span> (f1&lt;f2)
01296         {
01297                 *xmin=x1;
01298                 <span class="keywordflow">return</span> f1;
01299         }
01300         <span class="keywordflow">else</span>
01301         {
01302                 *xmin=x2;
01303                 <span class="keywordflow">return</span> f2;
01304         }
01305 }
01306 
<a name="l01307"></a><a class="code" href="group__perspective.html#a15">01307</a> <span class="keywordtype">bool</span> <a class="code" href="group__perspective.html#a15">k_CalibrateWithRadialDistOld</a>(<a class="code" href="structT3D2DPoints.html">T3D2DPoints</a>* pPointSets,<a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, 
01308                                                            <span class="keywordtype">double</span>* k,<span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg)
01309 {
01310         <span class="keywordflow">if</span> ((pPointSets==NULL) || (pMat==NULL) || (k==NULL) || (pImg==NULL))
01311         {
01312                 <a class="code" href="structTString.html">TString</a> str;
01313                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
01314                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
01315                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,
01316                         <span class="stringliteral">"k_CalibrateWithRadialDist() One of the given parameters is a NULL pointer"</span>);
01317                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
01318                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
01319         }
01320         <span class="comment">/*      do not accept a T3D2DPoints structure with entries</span>
01321 <span class="comment">                where either the 2D or 3D point is not in use */</span>
01322         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>!=<a class="code" href="group__corresponding3d2dpoints.html#a9">k_GetTotal3D2DPointSetsInUse</a>(pPointSets))
01323         {
01324                 <a class="code" href="structTString.html">TString</a> str;
01325                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
01326                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
01327                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() The T3D2DPoints structure containes entries "</span>
01328                         <span class="stringliteral">"where either the 2D or 3D point is not used"</span>);
01329                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
01330                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
01331         }
01332         <span class="comment">/* check if there are at least 6 point sets */</span>
01333         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>&lt;6)
01334         {
01335                 <a class="code" href="structTString.html">TString</a> str;
01336                 <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
01337                 <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
01338                 <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_ERROR,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() Need 6 refernce marks "</span>
01339                         <span class="stringliteral">"(current is %d)"</span>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>);
01340                 <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
01341                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
01342         }
01343         <span class="keywordflow">else</span>
01344         {
01345                 <span class="keyword">const</span> <span class="keywordtype">double</span> LOWER_VAL=0;
01346                 <span class="keyword">const</span> <span class="keywordtype">double</span> UPPER_VAL=0.000005; <span class="comment">/* 5e-6 since version 1.60*/</span>
01347                 <span class="comment">/*const double UPPER_VAL=0.000001;*/</span> <span class="comment">/* 1e-6 */</span>
01348                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ITERATIONS=100;
01349                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
01350                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iterate=0;
01351                 <span class="keywordtype">double</span> LowValError,UpperValError,NewError;
01352                 <span class="keywordtype">double</span> LowVal=LOWER_VAL;
01353                 <span class="keywordtype">double</span> UpperVal=UPPER_VAL;
01354                 <span class="keywordtype">double</span> NewVal;
01355                 <a class="code" href="structT3D2DPoints.html">T3D2DPoints</a> NewPointSets;
01356                 <a class="code" href="group__corresponding3d2dpoints.html#a0">k_Init3D2DPoints</a>(&amp;NewPointSets);
01357                 <span class="comment">/* initialize system */</span>
01358                 LowValError=k_RadialCalibAndGetMeanErrorOld(pPointSets,LowVal,pImg);
01359                 UpperValError=k_RadialCalibAndGetMeanErrorOld(pPointSets,UpperVal,pImg);
01360 
01361                 <span class="comment">/* search for a "bracketing minimum" error between 0 and UPPER_VAL,</span>
01362 <span class="comment">                        when found a golden search method is used for finding the minimum</span>
01363 <span class="comment">                        error between this bracketed interval */</span>
01364                 <span class="keywordflow">for</span>(iterate=0;iterate&lt;ITERATIONS;iterate++)
01365                 {
01366                         NewVal=(LowVal+UpperVal)/2.0;
01367                         NewError=k_RadialCalibAndGetMeanErrorOld(pPointSets,NewVal,pImg);
01368                 
01369                         <span class="keywordflow">if</span> ((NewError&gt;LowValError) &amp;&amp; (NewError&lt;UpperValError))
01370                         {
01371                                 UpperVal=NewVal;
01372                                 UpperValError=NewError;
01373                         }
01374                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((NewError&lt;LowValError) &amp;&amp; (NewError&gt;UpperValError))
01375                         {
01376                                 LowVal=NewVal;
01377                                 LowValError=NewError;
01378                         }
01379                         <span class="keywordflow">else</span>
01380                         {       
01381                                 <span class="comment">/* if we end up here, we have a bracketed minimum, </span>
01382 <span class="comment">                                        that is: NewError&lt;LowValError and NewError&lt;UpperValError */</span>
01383                                 <span class="keywordtype">double</span> Tolerance=1e-8;
01384                                 <span class="comment">/*double test=*/</span>
01385                                 k_CalibGoldenSearchOld(LowVal,NewVal,UpperVal,Tolerance,&amp;NewVal,
01386                                                   pPointSets,pImg);
01387                                 <span class="keywordflow">break</span>;
01388 
01389                         }
01390                 }
01391                 <span class="keywordflow">if</span> (iterate&gt;=ITERATIONS)
01392                 {
01393                         <span class="comment">/* a bracketed minimum was never found, warn the user */</span>
01394                         <a class="code" href="structTString.html">TString</a> str;
01395                         <a class="code" href="group__string.html#a0">k_InitString</a>(&amp;str);
01396                         <a class="code" href="group__string.html#a15">k_AddFileAndLine</a>(str);
01397                         <a class="code" href="group__errorhandling.html#a0">k_ShowMessage</a>(IPL_WARNING,&amp;str,<span class="stringliteral">"k_CalibrateWithRadialDist() Couldn't find a suitable"</span>
01398                                 <span class="stringliteral">" distortion value k better than the initial 0 (no radial correction)"</span>);
01399                         <a class="code" href="group__string.html#a1">k_EmptyString</a>(&amp;str);
01400                 }
01401 
01402                 *k=NewVal;
01403                 <a class="code" href="group__corresponding3d2dpoints.html#a8">k_Copy3D2DPoints</a>(&amp;NewPointSets,pPointSets);
01404                 <span class="keywordflow">for</span>(i=0; i&lt;pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m1">NumberOfSets</a>;i++)
01405                 {
01406                         <a class="code" href="structT2DFloat.html">T2DFloat</a> P2d;
01407                         P2d=<a class="code" href="group__perspective.html#a18">k_GetPosRadRemovedOld</a>(pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m0">x</a>,pPointSets-&gt;<a class="code" href="structT3D2DPoints.html#m0">pSet</a>[i].<a class="code" href="structTSinglePointSet.html#m2">Pnt2D</a>.<a class="code" href="structT2DFloat.html#m1">y</a>,pImg,*k);
01408                         <a class="code" href="group__corresponding3d2dpoints.html#a18">k_SetPoint2DIn3D2DPoints</a>(&amp;P2d,i,&amp;NewPointSets);
01409                 }
01410                 <a class="code" href="group__perspective.html#a1">k_CalibrateCamera</a>(&amp;NewPointSets,pMat);
01411                 <a class="code" href="group__corresponding3d2dpoints.html#a1">k_Empty3D2DPoints</a>(&amp;NewPointSets);
01412                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
01413         }
01414 }
01415 
<a name="l01416"></a><a class="code" href="group__perspective.html#a16">01416</a> <span class="keywordtype">void</span> <a class="code" href="group__perspective.html#a16">k_Calc3DTo2DRadOld</a>(<a class="code" href="structT3DFloat.html">T3DFloat</a> w, <span class="keyword">const</span> <a class="code" href="structTCameraMatrix.html">TCameraMatrix</a>* pMat, <span class="keywordtype">double</span> k, <a class="code" href="structT2DFloat.html">T2DFloat</a>* pPnt, <span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg)
01417 {
01418         <a class="code" href="group__perspective.html#a2">k_Calc3DTo2D</a>(w,pMat,pPnt);
01419         <span class="comment">/* inverse adjust for radial distortion */</span>
01420         (*pPnt)=k_InverseRadialMove(pPnt-&gt;<a class="code" href="structT2DFloat.html#m0">x</a>-(pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0),pPnt-&gt;<a class="code" href="structT2DFloat.html#m1">y</a>-(pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0),k);
01421         pPnt-&gt;<a class="code" href="structT2DFloat.html#m0">x</a>+=(<span class="keywordtype">float</span>)(pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
01422         pPnt-&gt;<a class="code" href="structT2DFloat.html#m1">y</a>+=(<span class="keywordtype">float</span>)(pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
01423 }
01424 
<a name="l01425"></a><a class="code" href="group__perspective.html#a17">01425</a> <a class="code" href="structT2DInt.html">T2DInt</a> <a class="code" href="group__perspective.html#a17">k_GetMaxRadialDisplacementOld</a>(<span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg, <span class="keywordtype">double</span> k)
01426 {
01427         <a class="code" href="structT2DInt.html">T2DInt</a> ImageCenter;
01428         <span class="keywordtype">float</span> u,v;
01429         <a class="code" href="structT2DInt.html">T2DInt</a> MaxRadDispl;
01430         ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>=(short)<span class="comment">/*k_Round*/</span>(pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
01431         ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>=(short)<span class="comment">/*k_Round*/</span>(pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
01432         u=(float)(pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>-ImageCenter.<a class="code" href="structT2DInt.html#m0">x</a>);
01433         v=(float)(pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>-ImageCenter.<a class="code" href="structT2DInt.html#m1">y</a>);
01434         MaxRadDispl.<a class="code" href="structT2DInt.html#m0">x</a>=<a class="code" href="group__c__globals.html#a5">k_Round</a>(k*u*(u*u+v*v));
01435         MaxRadDispl.<a class="code" href="structT2DInt.html#m1">y</a>=<a class="code" href="group__c__globals.html#a5">k_Round</a>(k*v*(u*u+v*v));
01436         <span class="keywordflow">return</span> MaxRadDispl;
01437 }
01438 
<a name="l01439"></a><a class="code" href="group__perspective.html#a18">01439</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a18">k_GetPosRadRemovedOld</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> x,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> y,<span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg, <span class="keywordtype">double</span> k)
01440 {
01441         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
01442         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> u=(FLOAT32)(x-pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
01443         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> v=(FLOAT32)(y-pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
01444         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>=x;
01445         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=y;
01446         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=(FLOAT32)k*u*(u*u+v*v);
01447         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=(FLOAT32)k*v*(u*u+v*v);
01448         <span class="keywordflow">return</span> NewPos;
01449 }
01450 
<a name="l01451"></a><a class="code" href="group__perspective.html#a19">01451</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a19">k_GetPosRadRemovedCOld</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> x,<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> y, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY, <span class="keywordtype">double</span> k)
01452 {
01453         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
01454         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> u=(FLOAT32)(x-CenterX);
01455         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> v=(FLOAT32)(y-CenterY);
01456         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>=x;
01457         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>=y;
01458         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=(FLOAT32)k*u*(u*u+v*v);
01459         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=(FLOAT32)k*v*(u*u+v*v);
01460         <span class="keywordflow">return</span> NewPos;
01461 }
01462 
<a name="l01463"></a><a class="code" href="group__perspective.html#a20">01463</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a20">k_GetPosInverseRadOld</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> xr, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> yr, <span class="keyword">const</span> <a class="code" href="structTImage.html">TImage</a>* pImg, <span class="keywordtype">double</span> k)
01464 {
01465         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
01466         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX=(FLOAT32)(pImg-&gt;<a class="code" href="structTImage.html#m4">Width</a>/2.0);
01467         <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY=(FLOAT32)(pImg-&gt;<a class="code" href="structTImage.html#m5">Height</a>/2.0);
01468         NewPos=k_InverseRadialMove(((<span class="keywordtype">double</span>)xr)-CenterX,((<span class="keywordtype">double</span>)yr)-CenterY,k);
01469         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=CenterX;
01470         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=CenterY;
01471         <span class="keywordflow">return</span> NewPos;
01472 }
01473 
<a name="l01474"></a><a class="code" href="group__perspective.html#a21">01474</a> <a class="code" href="structT2DFloat.html">T2DFloat</a> <a class="code" href="group__perspective.html#a21">k_GetPosInverseRadCOld</a>(<a class="code" href="group__valuetypes.html#a6">FLOAT32</a> xr, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> yr, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterX, <a class="code" href="group__valuetypes.html#a6">FLOAT32</a> CenterY, <span class="keywordtype">double</span> k)
01475 {
01476         <a class="code" href="structT2DFloat.html">T2DFloat</a> NewPos;
01477         NewPos=k_InverseRadialMove(((<span class="keywordtype">double</span>)xr)-CenterX,((<span class="keywordtype">double</span>)yr)-CenterY,k);
01478         NewPos.<a class="code" href="structT2DFloat.html#m0">x</a>+=CenterX;
01479         NewPos.<a class="code" href="structT2DFloat.html#m1">y</a>+=CenterY;
01480         <span class="keywordflow">return</span> NewPos;
01481 }
01482 
01483 <span class="preprocessor">#ifdef _IPL98_USING_CPP</span>
01484 <span class="preprocessor"></span>} <span class="comment">/* end of extern "C" */</span>
01485 } <span class="comment">/* end namespace ipl */</span>
01486 <span class="preprocessor">#endif</span>
</pre></div><!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<head>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<title>Tag</title>
<base target="_top">
</head>

<body bgcolor="#FFFFFF">

<hr>

<p align="right"><font size="2"><em>Updated <!--webbot bot="Timestamp" s-type="EDITED" s-format="%d. %B %Y %H:%M" startspan -->21. juli 2002 12:29<!--webbot bot="Timestamp" endspan i-checksum="38834" --> by
<a href="http://www.mip.sdu.dk/~edr/">René Dencker
Eriksen</a>(<a href="mailto:edr@mip.sdu.dk">edr@mip.sdu.dk</a>)</em></font></p>
</body>
</html>
