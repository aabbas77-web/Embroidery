<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<link type="text/css" href="../../doxygen.css" rel="stylesheet">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Image Processing Library 98</title>
</head>

<body>
<h2 align="center"><a href="http://www.mip.sdu.dk/ipl98" target="_blank"><img border="0" src="ipl_doc_header.gif" width="694" height="55"></a></h2>

</body>

</html>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>/ipl98/cpp/algorithms/hough_transform/hough_sht_line.cpp</h1><div class="fragment"><pre>00001 <span class="comment">/********************************************************************</span>
00002 <span class="comment">   The Image Processing Library 98 - IPL98</span>
00003 <span class="comment">   Copyright (C) by René Dencker Eriksen - edr@mip.sdu.dk</span>
00004 <span class="comment"></span>
00005 <span class="comment">   This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">   modify it under the terms of the GNU Lesser General Public</span>
00007 <span class="comment">   License as published by the Free Software Foundation. Only</span>
00008 <span class="comment">   addition is, that if the library is used in proprietary software</span>
00009 <span class="comment">   it must be stated that IPL98 was used.</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This library is distributed in the hope that it will be useful,</span>
00012 <span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
00014 <span class="comment"></span>
00015 <span class="comment">   More details can be found in the file licence.txt distributed</span>
00016 <span class="comment">   with this library.</span>
00017 <span class="comment">*********************************************************************/</span>
00018 
00019 <span class="preprocessor">#include "hough_sht_line.h"</span>
00020 
00021 <span class="keyword">namespace </span>ipl {
00022 
00024 <span class="comment">// Construction/Destruction</span>
00026 <span class="comment"></span>
00027 
<a name="l00028"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a0">00028</a> CHoughSHTLine::CHoughSHTLine(ostream&amp; os, <span class="keywordtype">bool</span> WriteOutputFiles, <span class="keyword">const</span> string&amp; FilePrefix) : m_os(os)
00029 {
00030         m_initialized = <span class="keyword">false</span>;
00031         m_writeOutputFiles = WriteOutputFiles;
00032         m_filePrefix = FilePrefix;
00033 }
00034 
00035 
<a name="l00036"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a1">00036</a> CHoughSHTLine::~CHoughSHTLine()
00037 {
00038 }
00039 
00040 
00042 <span class="comment">// Public methods</span>
00044 <span class="comment"></span>
00045 
<a name="l00046"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a2">00046</a> <span class="keywordtype">bool</span> CHoughSHTLine::Initialize(COLORTYPE Color, UINT8 Threshold, CHoughBase::ORIGINTYPE OriginType, 
00047         CHoughBase::PARAMETERTYPE ParamType)
00048 {
00049         <span class="keywordflow">if</span> (Color == HIGHCOLOR) m_color = HIGHCOLOR;
00050         <span class="keywordflow">else</span> m_color = LOWCOLOR;
00051         m_imgThreshold = Threshold;
00052         m_originType = OriginType;
00053         m_paramType = ParamType;
00054         m_initialized = <span class="keyword">true</span>;
00055         
00056         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00057 }
00058 
00059 
<a name="l00060"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a3">00060</a> <span class="keywordtype">bool</span> CHoughSHTLine::PerformTransform(<span class="keyword">const</span> <a class="code" href="classipl_1_1CStdImage.html">CStdImage</a>&amp; Source, <span class="keywordtype">int</span> Thickness)
00061 {
00062         <span class="keywordflow">if</span> (!m_initialized)
00063         {
00064                 ostringstream ost;
00065                 ost &lt;&lt; <span class="stringliteral">"CHoughSHTLine::StandardHoughTransform() Not initialized"</span> &lt;&lt; IPLAddFileAndLine;
00066                 CError::ShowMessage(IPL_ERROR,ost.str().c_str());
00067                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00068         }
00069         <span class="keywordflow">if</span> ((Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>()!=1) &amp;&amp; (Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>()!=8))
00070         {
00071                 ostringstream ost;
00072                 ost &lt;&lt; <span class="stringliteral">"CHoughSHTLine::StandardHoughTransform() Source must be 1 or 8 b/p (current is "</span> 
00073                         &lt;&lt; Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>() &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; IPLAddFileAndLine;
00074                 CError::ShowMessage(IPL_ERROR,ost.str().c_str());
00075                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00076         }
00077         this-&gt;UpdateHoughSpace(Source, Thickness);
00078         
00079         m_os &lt;&lt; <span class="stringliteral">"Performing standard Hough transform..."</span> &lt;&lt; endl;
00080         m_os &lt;&lt; <span class="stringliteral">"Finished procentage:"</span> &lt;&lt; endl;
00081         <span class="keywordtype">int</span> p;
00082         <span class="keywordtype">int</span> width = Source.<a class="code" href="classipl_1_1CStdImage.html#a50">GetWidth</a>();
00083         <span class="keywordtype">int</span> height = Source.<a class="code" href="classipl_1_1CStdImage.html#a51">GetHeight</a>();
00084         <span class="keywordtype">int</span> x, y, xi, yi;
00085         <span class="keywordtype">int</span> procent = 0, procent_old = 0;
00086         <span class="keywordtype">bool</span> color = <span class="keyword">false</span>;
00087         <span class="keywordflow">if</span> (m_color == HIGHCOLOR) color = <span class="keyword">true</span>;
00088         
00089         <span class="keywordflow">for</span> (y=0; y&lt;height; y++)
00090         {
00091                 <span class="comment">// compute finished procentage</span>
00092                 procent = (int) (100.0*y/height);
00093                 <span class="keywordflow">if</span> (procent &gt; procent_old)
00094                 {
00095                         m_os &lt;&lt; <span class="stringliteral">"#"</span>;
00096                         procent_old = procent;
00097                 }
00098                 
00099                 yi = m_imgOriginOrientation.<a class="code" href="classCPoint2D.html#a14">GetY</a>()*(y-m_imgOriginPosition.<a class="code" href="classCPoint2D.html#a14">GetY</a>());
00100                 <span class="keywordflow">for</span>(x=0; x&lt;width; x++)
00101                 {
00102                         p = Source.<a class="code" href="classipl_1_1CStdImage.html#a21">GetPixelFast</a>(x,y);         
00103                         <span class="keywordflow">if</span> ((color)^(p&gt;m_imgThreshold))
00104                         {    <span class="comment">// Used for both low/high color images</span>
00105                                 xi = m_imgOriginOrientation.<a class="code" href="classCPoint2D.html#a13">GetX</a>()*(x-m_imgOriginPosition.<a class="code" href="classCPoint2D.html#a13">GetX</a>());
00106                                 <span class="keywordflow">if</span> (m_paramType == CHoughBase::NORMAL_PARAM) 
00107                                         this-&gt;ComputeHoughNormal(xi, yi);
00108                                 <span class="keywordflow">else</span> 
00109                                         this-&gt;ComputeHoughSlope(xi, yi);
00110                         }
00111                         <span class="comment">// else if (m_color &amp;&amp; p&lt;m_threshold) this-&gt;ComputeHough(x,y);</span>
00112                 }
00113         }
00114         
00115         <span class="keywordflow">if</span> (m_writeOutputFiles)
00116         {
00117                 <a class="code" href="classipl_1_1CImage.html">CImage</a> img;
00118                 this-&gt;<a class="code" href="classipl_1_1CHoughSHTLine.html#a5">ToImage</a>(img);
00119                 img.<a class="code" href="classipl_1_1CImage.html#a11">Save</a>(m_filePrefix+<span class="stringliteral">"_HS_0.bmp"</span>);
00120         }
00121         
00122         m_os &lt;&lt; <span class="stringliteral">"\nStandard Hough transform for lines finished."</span> &lt;&lt; endl;
00123         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00124 }
00125 
00126 
<a name="l00127"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a4">00127</a> <a class="code" href="classipl_1_1CHoughSpace2D.html">CHoughSpace2D</a> CHoughSHTLine::GetHoughSpace()<span class="keyword"> const</span>
00128 <span class="keyword"></span>{ 
00129         <span class="keywordflow">return</span> m_houghSpace2D;
00130 }
00131 
00132 
<a name="l00133"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a5">00133</a> <span class="keywordtype">void</span> CHoughSHTLine::ToImage(<a class="code" href="classipl_1_1CStdImage.html">CStdImage</a>&amp; outImg)
00134 {
00135         m_houghSpace2D.<a class="code" href="classipl_1_1CHoughSpace2D.html#a6">ToImage</a>(outImg);
00136 }
00137 
00138 
<a name="l00139"></a><a class="code" href="classipl_1_1CHoughSHTLine.html#a6">00139</a> vector&lt;CParameter2D&lt;float&gt; &gt; CHoughSHTLine::FindPeaks(CHoughBase::PEAKDETECTIONTYPE DetectionMethod, 
00140         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> HSThreshold)
00141 {
00142         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0;
00143         m_houghSpace2D.<a class="code" href="classipl_1_1CHoughSpace2D.html#a11">SetThreshold</a>(HSThreshold);
00144         vector&lt;CParameter2D&lt;float&gt; &gt; peaks = m_houghSpace2D.<a class="code" href="classipl_1_1CHoughSpace2D.html#a18">FindPeaks</a>(DetectionMethod);
00145         <span class="keywordflow">if</span> (m_writeOutputFiles)
00146         {
00147                 <a class="code" href="classipl_1_1CImage.html">CImage</a> img;
00148                 img.<a class="code" href="classipl_1_1CImage.html#a7">Alloc</a>(m_imageDimensions.<a class="code" href="classCPoint2D.html#a13">GetX</a>(), m_imageDimensions.<a class="code" href="classCPoint2D.html#a14">GetY</a>(), 8);
00149                 img.<a class="code" href="classipl_1_1CStdImage.html#a16">Flush</a>(255); 
00150                 <span class="keywordflow">while</span> (k &lt; peaks.size())
00151                 {
00152                         <a class="code" href="classCParameter2D.html">CParameter2D&lt;float&gt;</a> param = peaks[k];
00153                         m_os &lt;&lt; <span class="stringliteral">"Parameter "</span> &lt;&lt; k &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; param &lt;&lt; endl;      
00154                         CHoughBase::DrawLine(img, param);
00155                         
00156                         string filename = <span class="stringliteral">""</span>;
00157                         <span class="keywordtype">char</span> no[2];
00158                         sprintf(no, <span class="stringliteral">"%i"</span>, k);
00159                         filename = m_filePrefix + <span class="stringliteral">"_RC_SHT_"</span> + no + <span class="stringliteral">".bmp"</span>;
00160                         img.<a class="code" href="classipl_1_1CImage.html#a11">Save</a>(filename);
00161                         k++;
00162                 }
00163         }
00164         <span class="keywordflow">return</span> peaks;
00165 }
00166 
00167 
00169 <span class="comment">// Private methods</span>
00171 <span class="comment"></span>
00172 
00173 <span class="keywordtype">void</span> CHoughSHTLine::ComputeSinCosTheta(<span class="keywordtype">int</span> n)
00174 {
00175         m_os &lt;&lt; <span class="stringliteral">"Computing sine and cosine value vectors..."</span> &lt;&lt; endl;
00176         <span class="keywordtype">float</span> T = m_houghSpace2D.GetParameterRangeValue(1,2) - m_houghSpace2D.GetParameterRangeValue(1,1);
00177         <span class="keywordtype">float</span> theta = (float) (-m_houghSpace2D.GetOffset(1)*T/n);
00178         <span class="keywordtype">float</span> step  = (float) (T/n);
00179         
00180         m_sinTheta.resize(n);
00181         m_cosTheta.resize(n);
00182         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;n; i++)
00183         {
00184                 m_sinTheta[i] = (float) sin(theta);
00185                 m_cosTheta[i] = (float) cos(theta);
00186                 theta += step;
00187         }
00188 }
00189 
00190 
00191 <span class="keywordtype">void</span> CHoughSHTLine::ComputeSlope(<span class="keywordtype">int</span> n)
00192 {
00193         m_os &lt;&lt; <span class="stringliteral">"Computing slope vector..."</span> &lt;&lt; endl;
00194         <span class="keywordtype">float</span> A = m_houghSpace2D.GetParameterRangeValue(1,2) - m_houghSpace2D.GetParameterRangeValue(1,1);
00195         <span class="keywordtype">float</span> step  = (float) (A/n);
00196         <span class="keywordtype">float</span> v = 0.0f;
00197         <span class="keywordtype">int</span> n2 = n/2;
00198         
00199         m_slopeVector.resize(n);
00200         m_slopeVector[n2] = 0.0f;
00201         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1; i&lt;n2; i++)
00202         {
00203                 v += step;
00204                 m_slopeVector[n2+i] = v;
00205                 m_slopeVector[n2-i] = -v;
00206         }
00207 }
00208 
00209 
00210 <span class="keywordtype">void</span> CHoughSHTLine::ComputeHoughNormal(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
00211 {
00212         <span class="keywordtype">float</span> pk;   
00213         <a class="code" href="classCPoint2D.html">CPoint2D&lt;int&gt;</a> position;
00214         <span class="keywordtype">float</span> rhoMin = m_houghSpace2D.GetParameterRangeValue(2,1);
00215         <span class="keywordtype">float</span> rhoMax = m_houghSpace2D.GetParameterRangeValue(2,2);
00216         <span class="keywordtype">int</span> param1Q = m_houghSpace2D.GetQuantizationValue(1);
00217         <span class="keywordtype">int</span> param2Q = m_houghSpace2D.GetQuantizationValue(2);
00218         
00219         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;param1Q; k++)
00220         {
00221                 pk = (float) (x*m_cosTheta[k] + y*m_sinTheta[k]);     <span class="comment">// kernel part</span>
00222                 <span class="keywordflow">if</span> (!(rhoMin&gt;=pk || pk&gt;rhoMax))
00223                 {
00224                         <span class="keywordtype">int</span> r = m_houghSpace2D.Discretize(2, pk);
00225                         <span class="keywordflow">if</span> (0&lt;=r &amp;&amp; r&lt;param2Q)
00226                         {
00227                                 position.<a class="code" href="classCPoint2D.html#a15">Set</a>(k,r);
00228                                 m_houghSpace2D.Inc(position);
00229                         } 
00230                 }
00231                 <span class="keywordflow">else</span>
00232                 {
00233                         ostringstream ost;
00234                         ost &lt;&lt; <span class="stringliteral">"CHoughSHTLine::ComputeHoughNormal() Out of range error"</span> &lt;&lt; IPLAddFileAndLine;
00235                         CError::ShowMessage(IPL_ERROR,ost.str().c_str());
00236                 }
00237         }
00238 }
00239 
00240 
00241 <span class="keywordtype">void</span> CHoughSHTLine::ComputeHoughSlope(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
00242 {
00243         <span class="keywordtype">float</span> bk;
00244         <a class="code" href="classCPoint2D.html">CPoint2D&lt;int&gt;</a> position;
00245         <span class="keywordtype">float</span> bMin = m_houghSpace2D.GetParameterRangeValue(2,1);
00246         <span class="keywordtype">float</span> bMax = m_houghSpace2D.GetParameterRangeValue(2,2);
00247         <span class="keywordtype">int</span> param1Q = m_houghSpace2D.GetQuantizationValue(1);
00248         <span class="keywordtype">int</span> param2Q = m_houghSpace2D.GetQuantizationValue(2);
00249         
00250         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;param1Q; k++)
00251         {
00252                 bk = (float) (-m_slopeVector[k]*x + y);
00253                 <span class="keywordflow">if</span> (!(bMin&gt;=bk || bk&gt;bMax))
00254                 {
00255                         <span class="keywordtype">int</span> b = m_houghSpace2D.Discretize(2, bk);
00256                         <span class="keywordflow">if</span> (0&lt;=b &amp;&amp; b&lt;param2Q)
00257                         {
00258                                 position.<a class="code" href="classCPoint2D.html#a15">Set</a>(k,b);
00259                                 m_houghSpace2D.Inc(position);
00260                         } 
00261                 }
00262         }
00263 }
00264 
00265 
00266 <span class="keywordtype">void</span> CHoughSHTLine::SetOrigin(CHoughBase::ORIGINTYPE OriginType)
00267 {
00268         <a class="code" href="classCPoint2D.html">CPoint2D&lt;int&gt;</a> P,O;
00269         <span class="keywordflow">switch</span>(OriginType)
00270         {
00271         <span class="keywordflow">case</span> CHoughBase::LEFT_UPPER:
00272                 P.<a class="code" href="classCPoint2D.html#a15">Set</a>(0,0);
00273                 O.<a class="code" href="classCPoint2D.html#a15">Set</a>(1,1);
00274                 <span class="keywordflow">break</span>;
00275         <span class="keywordflow">case</span> CHoughBase::CENTER_UP:
00276                 P = m_imageDimensions/2;
00277                 O.<a class="code" href="classCPoint2D.html#a15">Set</a>(1,-1);
00278                 <span class="keywordflow">break</span>;
00279         <span class="keywordflow">case</span> CHoughBase::CENTER_DOWN:
00280                 P = m_imageDimensions/2;
00281                 O.<a class="code" href="classCPoint2D.html#a15">Set</a>(1,1);
00282                 <span class="keywordflow">break</span>;
00283         <span class="keywordflow">default</span>:
00284                 P = m_imageDimensions/2;
00285                 O.<a class="code" href="classCPoint2D.html#a15">Set</a>(1,-1);
00286                 <span class="keywordflow">break</span>;
00287         }
00288         m_imgOriginPosition = P;
00289         m_imgOriginOrientation = O;
00290 }
00291 
00292 
00293 <span class="keywordtype">void</span> CHoughSHTLine::UpdateHoughSpace(<span class="keyword">const</span> CStdImage&amp; Source, <span class="keywordtype">int</span> Thickness)
00294 {
00295         m_imageDimensions.<a class="code" href="classCPoint2D.html#a15">Set</a>(Source.GetWidth(),Source.GetHeight());
00296         SetOrigin(m_originType);
00297         <span class="comment">// last parameter (100) below not used, always reset in FindPeaks()</span>
00298         m_houghSpace2D.Initialize(Source.GetWidth(), Source.GetHeight(), Thickness, 100, m_paramType);
00299         
00300         <span class="keywordflow">switch</span> (m_paramType)
00301         {
00302         <span class="keywordflow">case</span> CHoughBase::SLOPE_PARAM:
00303                 this-&gt;ComputeSlope(m_houghSpace2D.GetQuantizationValue(1));
00304                 <span class="keywordflow">break</span>;
00305         <span class="keywordflow">case</span> CHoughBase::NORMAL_PARAM:
00306                 this-&gt;ComputeSinCosTheta(m_houghSpace2D.GetQuantizationValue(1));
00307                 <span class="keywordflow">break</span>;
00308         }
00309 }
00310 
00311 
00312 } <span class="comment">// end namespace ipl</span>
</pre></div><!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<head>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<title>Tag</title>
<base target="_top">
</head>

<body bgcolor="#FFFFFF">

<hr>

<p align="right"><font size="2"><em>Updated <!--webbot bot="Timestamp" s-type="EDITED" s-format="%d. %B %Y %H:%M" startspan -->21. juli 2002 12:29<!--webbot bot="Timestamp" endspan i-checksum="38834" --> by
<a href="http://www.mip.sdu.dk/~edr/">René Dencker
Eriksen</a>(<a href="mailto:edr@mip.sdu.dk">edr@mip.sdu.dk</a>)</em></font></p>
</body>
</html>
