<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<link type="text/css" href="../../doxygen.css" rel="stylesheet">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Image Processing Library 98</title>
</head>

<body>
<h2 align="center"><a href="http://www.mip.sdu.dk/ipl98" target="_blank"><img border="0" src="ipl_doc_header.gif" width="694" height="55"></a></h2>

</body>

</html>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>/ipl98/cpp/algorithms/hough_transform/hough_rht_line.cpp</h1><div class="fragment"><pre>00001 <span class="comment">/********************************************************************</span>
00002 <span class="comment">   The Image Processing Library 98 - IPL98</span>
00003 <span class="comment">   Copyright (C) by René Dencker Eriksen - edr@mip.sdu.dk</span>
00004 <span class="comment"></span>
00005 <span class="comment">   This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">   modify it under the terms of the GNU Lesser General Public</span>
00007 <span class="comment">   License as published by the Free Software Foundation. Only</span>
00008 <span class="comment">   addition is, that if the library is used in proprietary software</span>
00009 <span class="comment">   it must be stated that IPL98 was used.</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This library is distributed in the hope that it will be useful,</span>
00012 <span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
00014 <span class="comment"></span>
00015 <span class="comment">   More details can be found in the file licence.txt distributed</span>
00016 <span class="comment">   with this library.</span>
00017 <span class="comment">*********************************************************************/</span>
00018 
00019 <span class="preprocessor">#include "hough_rht_line.h"</span>
00020 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00021 <span class="preprocessor">#include &lt;time.h&gt;</span>
00022 
00023 <span class="keyword">namespace </span>ipl {
00024 
00025 <span class="keyword">using</span> std::find;
00026 
00028 <span class="comment">// Construction/Destruction</span>
00030 <span class="comment"></span>
00031 
00032 CHoughRHTLine::CHoughRHTLine() : m_os(cout) {
00033 }
00034 
00035 
00036 CHoughRHTLine::CHoughRHTLine(ostream&amp; os, <span class="keywordtype">bool</span> WriteOutputFiles, <span class="keyword">const</span> string&amp; FilePrefix) : m_os(os) {
00037    m_initialized = <span class="keyword">false</span>;
00038    m_writeOutputFiles = WriteOutputFiles;
00039    m_filePrefix = FilePrefix;
00040    m_houghSpace2D = NULL;
00041 }
00042 
00043 
<a name="l00044"></a><a class="code" href="classipl_1_1CHoughRHTLine.html#a2">00044</a> CHoughRHTLine::~CHoughRHTLine() { 
00045    <span class="comment">// if (m_houghSpace2D!=NULL) delete m_houghSpace2D;</span>
00046 }
00047 
00048 
00050 <span class="comment">// Public methods</span>
00052 <span class="comment"></span>
00053 
<a name="l00054"></a><a class="code" href="classipl_1_1CHoughRHTLine.html#a3">00054</a> <span class="keywordtype">bool</span> CHoughRHTLine::Initialize(<a class="code" href="classipl_1_1CBinaryImage.html">CBinaryImage</a>&amp; BinarySource, <span class="keywordtype">int</span> Thickness, 
00055                                  CHoughBase::PARAMETERSPACETYPE SpaceType, CHoughBase::PARAMETERTYPE ParamType) {
00056    m_binaryImage = BinarySource;
00057    <span class="keywordflow">return</span> this-&gt;InitializeCommon(Thickness, SpaceType, ParamType);
00058 }
00059 
00060 
<a name="l00061"></a><a class="code" href="classipl_1_1CHoughRHTLine.html#a4">00061</a> <span class="keywordtype">bool</span> CHoughRHTLine::Initialize(<span class="keyword">const</span> <a class="code" href="classipl_1_1CStdImage.html">CStdImage</a>&amp; Source, COLORTYPE Color, UINT8 Threshold, 
00062                                                            CHoughBase::ORIGINTYPE OriginType, <span class="keywordtype">int</span> Thickness, 
00063                                                            CHoughBase::PARAMETERSPACETYPE SpaceType, CHoughBase::PARAMETERTYPE ParamType) {
00064    <span class="keywordflow">if</span> ((Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>()!=1) &amp;&amp; (Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>()!=8)) {
00065                 ostringstream ost;
00066                 ost &lt;&lt; <span class="stringliteral">"CHoughRHTLine::Initialize() Source must be 1 or 8 b/p (current is "</span> 
00067                         &lt;&lt; Source.<a class="code" href="classipl_1_1CStdImage.html#a68">GetBits</a>() &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; IPLAddFileAndLine;
00068                 CError::ShowMessage(IPL_ERROR,ost.str().c_str());
00069                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00070         }
00071    m_binaryImage = <a class="code" href="classipl_1_1CBinaryImage.html">CBinaryImage</a>(Source, Color, Threshold, OriginType);
00072    <span class="keywordflow">return</span> this-&gt;InitializeCommon(Thickness, SpaceType, ParamType);
00073 }
00074 
00075 
<a name="l00076"></a><a class="code" href="classipl_1_1CHoughRHTLine.html#a6">00076</a> vector&lt;CParameter2D&lt;float&gt; &gt; CHoughRHTLine::PerformTransform(<span class="keywordtype">int</span> HSThreshold, <span class="keywordtype">int</span> MaxNumShapes) {
00077    vector&lt;CParameter2D&lt;float&gt; &gt; peak_coordinates_real;
00078 
00079    <span class="keywordflow">if</span> (!m_initialized) {
00080                 ostringstream ost;
00081                 ost &lt;&lt; <span class="stringliteral">"CHoughRHTLine::RandomizedHoughTransform() Not initialized"</span> &lt;&lt; IPLAddFileAndLine;
00082                 CError::ShowMessage(IPL_ERROR,ost.str().c_str());
00083                 peak_coordinates_real.empty();
00084                 <span class="keywordflow">return</span> peak_coordinates_real;
00085         }
00086 
00087    <span class="keywordtype">int</span> k = 0;
00088    <span class="keywordtype">int</span> maxK = m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a7">GetSize</a>()*HSThreshold*MaxNumShapes/10;
00089    <span class="keywordtype">int</span> numofShapes = 0;
00090    <span class="keywordtype">int</span> procent = 0, procent_old = 0;
00091    <span class="keywordtype">bool</span> detected;
00092    m_houghSpace2D-&gt;<a class="code" href="classipl_1_1CHoughSpace2D.html#a11">SetThreshold</a>(HSThreshold);
00093 
00094    m_os &lt;&lt; <span class="stringliteral">"Randomized Hough transform started."</span> &lt;&lt; endl;
00095    m_os &lt;&lt; <span class="stringliteral">"Distance criterium (min): "</span> &lt;&lt; m_distanceCriteriumMin &lt;&lt; endl;
00096    m_os &lt;&lt; <span class="stringliteral">"Distance criterium (max): "</span> &lt;&lt; m_distanceCriteriumMax &lt;&lt; endl;   
00097    m_os &lt;&lt; <span class="stringliteral">"Detection threshold:      "</span> &lt;&lt; HSThreshold &lt;&lt; endl;
00098 
00099         <a class="code" href="classipl_1_1CBinaryImage.html">CBinaryImage</a> rc_bImg(m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a5">GetWidth</a>(), m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a6">GetHeight</a>(), m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a23">GetOrigin</a>());
00100 
00101    srand( (<span class="keywordtype">unsigned</span>) time( NULL ) );
00102    <span class="keywordflow">while</span> (k&lt;maxK &amp;&amp; numofShapes&lt;=MaxNumShapes &amp;&amp; m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a7">GetSize</a>()&gt;HSThreshold*3) {
00103 
00104       this-&gt;GetPixelPair();
00105       detected = this-&gt;ComputeRandomizedHough();
00106 
00107       <span class="keywordflow">if</span> (detected) {
00108 
00109          <a class="code" href="classCParameter2D.html">CParameter2D&lt;int&gt;</a> peak_disk = m_houghSpace2D-&gt;<a class="code" href="classipl_1_1CHoughSpace2D.html#a15">GetPeakCoordinates</a>();
00110          <a class="code" href="classCParameter2D.html">CParameter2D&lt;float&gt;</a> peak_coordinate_real = m_houghSpace2D-&gt;<a class="code" href="classipl_1_1CHoughSpace2D.html#a17">GetRealPeakCoordinates</a>();
00111          std::vector&lt;CPoint2D&lt;int&gt; &gt;::iterator p;
00112          p = find(m_peaks.begin(), m_peaks.end(), peak_disk);
00113          <span class="keywordflow">if</span> (p == m_peaks.end()) {  <span class="comment">// heuristic check</span>
00114             m_peaks.push_back(peak_disk);
00115                 peak_coordinates_real.push_back(peak_coordinate_real);
00116 
00117             numofShapes++;
00118             cout &lt;&lt; <span class="stringliteral">"Parameter "</span> &lt;&lt; numofShapes &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; peak_coordinate_real &lt;&lt; endl;
00119             m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a14">RemoveLine2</a>(peak_coordinate_real,2);
00120             <span class="keywordflow">if</span> (m_writeOutputFiles) this-&gt;WriteFiles(rc_bImg, peak_coordinate_real, numofShapes);
00121          } <span class="keywordflow">else</span> m_binaryImage.<a class="code" href="classipl_1_1CBinaryImage.html#a14">RemoveLine2</a>(peak_coordinate_real,5);
00122          m_houghSpace2D-&gt;<a class="code" href="classipl_1_1CHoughSpace2D.html#a5">Alloc</a>();
00123       }
00124 
00125       k++;
00126 
00127       <span class="comment">// compute finished procentage</span>
00128       procent = (int) (100.0*k/maxK);
00129       <span class="keywordflow">if</span> (procent &gt; procent_old) {
00130          m_os &lt;&lt; <span class="stringliteral">"#"</span>;
00131          procent_old = procent;
00132       }
00133    }
00134    <span class="keywordflow">return</span> peak_coordinates_real;
00135 }
00136 
00137 
<a name="l00138"></a><a class="code" href="classipl_1_1CHoughRHTLine.html#a5">00138</a> <span class="keywordtype">void</span> CHoughRHTLine::ToImage(<a class="code" href="classipl_1_1CStdImage.html">CStdImage</a>&amp; outImg) { 
00139    m_houghSpace2D-&gt;<a class="code" href="classipl_1_1CHoughSpace2D.html#a6">ToImage</a>(outImg); 
00140 }
00141 
00142 
00144 <span class="comment">// Private methods</span>
00146 <span class="comment"></span>
00147 
00148 <span class="keywordtype">bool</span> CHoughRHTLine::InitializeCommon(<span class="keywordtype">int</span> Thickness, CHoughBase::PARAMETERSPACETYPE SpaceType, 
00149                                      CHoughBase::PARAMETERTYPE ParamType) {
00150    <span class="keywordtype">int</span> width = m_binaryImage.GetWidth();
00151    <span class="keywordtype">int</span> height = m_binaryImage.GetHeight();
00152 
00153    <span class="keywordflow">switch</span> (SpaceType) {
00154         <span class="keywordflow">case</span> CHoughBase::QUANTIZATION_SPACE:
00155       m_houghSpace2D = <span class="keyword">new</span> CHoughSpace2D;
00156                 <span class="keywordflow">break</span>;
00157         <span class="keywordflow">case</span> CHoughBase::SPARSE_SPACE:
00158       m_houghSpace2D = <span class="keyword">new</span> CSparseHoughSpace2D;
00159                 <span class="keywordflow">break</span>;
00160         <span class="keywordflow">default</span>:
00161       m_houghSpace2D = <span class="keyword">new</span> CSparseHoughSpace2D;
00162                 <span class="keywordflow">break</span>;
00163         }
00164 
00165    m_houghSpace2D-&gt;Initialize(width, height, Thickness, 303, ParamType);
00166         this-&gt;ComputeSinCosTheta(m_houghSpace2D-&gt;GetWidth());
00167 
00168         m_distanceCriteriumMin = 2.0f;
00169         m_distanceCriteriumMax = m_houghSpace2D-&gt;GetParameterRangeValue(2,2);
00170 
00171    m_initialized = <span class="keyword">true</span>;
00172    <span class="keywordflow">return</span> <span class="keyword">true</span>;
00173 }
00174 
00175 
00176 <span class="keywordtype">void</span> CHoughRHTLine::ComputeSinCosTheta(<span class="keywordtype">int</span> n) {
00177    printf(<span class="stringliteral">"Computing sine and cosine value vectors...\n"</span>);
00178    <span class="keywordtype">float</span> T = m_houghSpace2D-&gt;GetParameterRangeValue(1,2) - m_houghSpace2D-&gt;GetParameterRangeValue(1,1);
00179    <span class="keywordtype">float</span> theta = (float) (-m_houghSpace2D-&gt;GetOffset(1)*T/n);
00180    <span class="keywordtype">float</span> step  = (float) (T/n);
00181 
00182    m_sinTheta.resize(n);
00183    m_cosTheta.resize(n);
00184    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;n; i++) {
00185       m_sinTheta[i] = (float) sin(theta);
00186       m_cosTheta[i] = (float) cos(theta);
00187       theta += step;
00188    }
00189 }
00190 
00191 
00192 <span class="keywordtype">void</span> CHoughRHTLine::WriteFiles(CBinaryImage&amp; BImage, <span class="keyword">const</span> <a class="code" href="classCParameter2D.html">CParameter2D&lt;float&gt;</a>&amp; Coordinate, <span class="keywordtype">int</span> NumOfShapes) {
00193    string filename;
00194    <span class="keywordtype">char</span> no[2];
00195    sprintf(no, <span class="stringliteral">"%i"</span>, NumOfShapes);
00196    CImage outImage;
00197 
00198    <span class="comment">// Reconstruction files</span>
00199    filename = <span class="stringliteral">""</span>;
00200    filename += m_filePrefix+<span class="stringliteral">"_RC_RHT_"</span>+no+<span class="stringliteral">".bmp"</span>;
00201    BImage.AddLine(Coordinate);
00202    BImage.ToImage(outImage);
00203    outImage.Save(filename);
00204 
00205    <span class="comment">// Original image files</span>
00206    filename = <span class="stringliteral">""</span>;
00207    filename += m_filePrefix+<span class="stringliteral">"_ORIGINAL_RHT_"</span>+no+<span class="stringliteral">".bmp"</span>;
00208    m_binaryImage.ToImage(outImage);
00209    outImage.Save(filename);
00210 
00211    <span class="comment">// Parameter space files</span>
00212    <span class="comment">/*</span>
00213 <span class="comment">   filename = "";</span>
00214 <span class="comment">   filename += Output+"_HS_RHT_"+no+".bmp";</span>
00215 <span class="comment">   m_houghSpace2D.ToImage(outImage);</span>
00216 <span class="comment">   outImage.Save(filename);</span>
00217 <span class="comment">   */</span>
00218 }
00219 
00220 
00221 <span class="keywordtype">void</span> CHoughRHTLine::GetPixelPair() {
00222    <span class="keywordtype">int</span> index1, index2;
00223    index1 = <a class="code" href="group__templates.html#a6">Round</a>(1.0f*rand()/RAND_MAX*m_binaryImage.GetSize());   <span class="comment">// get 1st index</span>
00224    index2 = <a class="code" href="group__templates.html#a6">Round</a>(1.0f*rand()/RAND_MAX*m_binaryImage.GetSize());   <span class="comment">// get 2nd index</span>
00225    m_p1 = m_binaryImage.GetPixel(index1);  
00226    m_p2 = m_binaryImage.GetPixel(index2);
00227 
00228    <span class="keywordflow">if</span> (this-&gt;DistanceCheck()) {
00229    } <span class="keywordflow">else</span> {
00230       this-&gt;GetPixelPair();
00231    }
00232 }
00233 
00234 
00235 <span class="keywordtype">float</span> CHoughRHTLine::Distance() {
00236    <span class="keywordtype">float</span> dx12 = m_p1.<a class="code" href="classCPoint2D.html#a13">GetX</a>() - m_p2.<a class="code" href="classCPoint2D.html#a13">GetX</a>();
00237    <span class="keywordtype">float</span> dy12 = m_p1.<a class="code" href="classCPoint2D.html#a14">GetY</a>() - m_p2.<a class="code" href="classCPoint2D.html#a14">GetY</a>();
00238    <span class="keywordflow">return</span> sqrt(dx12*dx12+dy12*dy12);
00239 }
00240 
00241 
00242 <span class="keywordtype">bool</span> CHoughRHTLine::DistanceCheck() {
00243    <span class="keywordtype">float</span> d = this-&gt;Distance();
00244    <span class="keywordflow">if</span> (m_distanceCriteriumMin &lt; d &amp;&amp; d &lt; m_distanceCriteriumMax) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00245    <span class="keywordflow">return</span> <span class="keyword">false</span>;
00246 }
00247 
00248 
00249 <span class="keywordtype">bool</span> CHoughRHTLine::ComputeRandomizedHough() {
00250    <span class="keywordtype">float</span> theta, rho;
00251    <span class="keywordtype">int</span> t=-1, r=-1;
00252 
00253    <span class="keywordtype">bool</span> detected = <span class="keyword">false</span>;
00254 
00255    <span class="keywordtype">float</span> rhoMin = m_houghSpace2D-&gt;GetParameterRangeValue(2,1);
00256    <span class="keywordtype">float</span> rhoMax = m_houghSpace2D-&gt;GetParameterRangeValue(2,2);
00257    <span class="keywordtype">int</span> param1Q = m_houghSpace2D-&gt;GetQuantizationValue(1);
00258    <span class="keywordtype">int</span> param2Q = m_houghSpace2D-&gt;GetQuantizationValue(2);
00259    <a class="code" href="classCPoint2D.html">CPoint2D&lt;int&gt;</a> position;
00260 
00261    theta = (float) atan((1.0*m_p1.<a class="code" href="classCPoint2D.html#a13">GetX</a>()-m_p2.<a class="code" href="classCPoint2D.html#a13">GetX</a>())/(m_p2.<a class="code" href="classCPoint2D.html#a14">GetY</a>()-m_p1.<a class="code" href="classCPoint2D.html#a14">GetY</a>()));
00262    <span class="keywordflow">if</span> (theta&lt;0.0f) theta += (float) PI;
00263 
00264    t = m_houghSpace2D-&gt;Discretize(1, theta);
00265    rho = m_p1.<a class="code" href="classCPoint2D.html#a13">GetX</a>()*cos(theta) + m_p1.<a class="code" href="classCPoint2D.html#a14">GetY</a>()*sin(theta);
00266    <span class="comment">// rho2 = m_p2.GetX()*cos(theta) + m_p2.GetY()*sin(theta);</span>
00267    <span class="comment">// rho = m_p1.GetX()*m_cosTheta[t] + m_p1.GetY()*m_sinTheta[t];</span>
00268 
00269    <span class="keywordflow">if</span> (!(rhoMin&gt;=rho || rho&gt;rhoMax)) {
00270       r = m_houghSpace2D-&gt;Discretize(2, rho);
00271 
00272       <span class="keywordflow">if</span> (0&lt;=t &amp;&amp; t&lt;param1Q &amp;&amp; 0&lt;=r &amp;&amp; r&lt;param2Q) {
00273                   position.<a class="code" href="classCPoint2D.html#a15">Set</a>(t,r);
00274         detected = m_houghSpace2D-&gt;Inc(position);
00275       }
00276    }
00277    <span class="comment">// cout &lt;&lt; position &lt;&lt; " " &lt;&lt; detected &lt;&lt; endl;</span>
00278    <span class="keywordflow">return</span> detected;
00279 }
00280 
00281 } <span class="comment">// end namespace ipl</span>
</pre></div><!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<head>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<title>Tag</title>
<base target="_top">
</head>

<body bgcolor="#FFFFFF">

<hr>

<p align="right"><font size="2"><em>Updated <!--webbot bot="Timestamp" s-type="EDITED" s-format="%d. %B %Y %H:%M" startspan -->21. juli 2002 12:29<!--webbot bot="Timestamp" endspan i-checksum="38834" --> by
<a href="http://www.mip.sdu.dk/~edr/">René Dencker
Eriksen</a>(<a href="mailto:edr@mip.sdu.dk">edr@mip.sdu.dk</a>)</em></font></p>
</body>
</html>
